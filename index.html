<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VoiceCal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://apis.google.com/js/api.js"></script>

<style>
body {
  margin:0;
  height:100vh;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  background:#111;
  color:white;
  font-family:Arial;
}

.mic-container {
  position:relative;
  width:220px;
  height:220px;
  display:flex;
  justify-content:center;
  align-items:center;
}

.ring {
  position:absolute;
  width:210px;
  height:210px;
  border-radius:50%;
  border:8px solid red;
  opacity:0;
}

.ring.active {
  opacity:1;
  animation:pulse 1.5s infinite;
}

@keyframes pulse {
  0%{transform:scale(1);}
  50%{transform:scale(1.08);}
  100%{transform:scale(1);}
}

#micButton {
  width:160px;
  cursor:pointer;
  z-index:2;
}

#status {
  margin-top:30px;
  text-align:center;
}
</style>
</head>
<body>

<h1>VoiceCal</h1>

<button onclick="handleAuthClick()">Sign In With Google</button>

<div class="mic-container">
  <div id="ring" class="ring"></div>
  <img src="/icon.png" id="micButton">
</div>

<p id="status">Tap mic</p>

<script>
const CLIENT_ID = "YOUR_GOOGLE_CLIENT_ID";
const API_KEY = "YOUR_GOOGLE_API_KEY";

const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

let tokenClient;
let gapiInited = false;
let gisInited = false;

function gapiLoaded() {
  gapi.load("client", initializeGapiClient);
}

async function initializeGapiClient() {
  await gapi.client.init({
    apiKey: API_KEY,
    discoveryDocs: [DISCOVERY_DOC],
  });
  gapiInited = true;
}

function handleAuthClick() {
  google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: async (tokenResponse) => {
      gapi.client.setToken(tokenResponse);
      alert("Signed in successfully.");
    },
  }).requestAccessToken();
}

function createEvent(title, start, end) {

  const event = {
    summary: title,
    start: { dateTime: start.toISOString() },
    end: { dateTime: end.toISOString() },
    reminders: {
      useDefault: false,
      overrides: [
        { method: "popup", minutes: 30 }
      ]
    }
  };

  gapi.client.calendar.events.insert({
    calendarId: "primary",
    resource: event
  }).then(() => {
    status.innerText = "Event created!";
    if (navigator.vibrate) navigator.vibrate(200);
  });
}

document.addEventListener("DOMContentLoaded", () => {

  gapiLoaded();

  const mic = document.getElementById("micButton");
  const ring = document.getElementById("ring");
  const status = document.getElementById("status");

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    status.innerText = "Speech not supported.";
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "en-US";

  recognition.onresult = function(e) {
    const text = e.results[0][0].transcript;
    status.innerText = text;
    parseCommand(text);
  };

  function parseCommand(text) {

    const lower = text.toLowerCase();
    let date = new Date();
    let match = lower.match(/(\d{1,2})(?::(\d{2}))?\s?(am|pm)/);

    if (!match) {
      status.innerText = "Couldn't detect time.";
      return;
    }

    let hour = parseInt(match[1]);
    let minute = match[2] ? parseInt(match[2]) : 0;
    const ampm = match[3];

    if (ampm === "pm" && hour !== 12) hour += 12;
    if (ampm === "am" && hour === 12) hour = 0;

    date.setHours(hour);
    date.setMinutes(minute);
    date.setSeconds(0);

    const endDate = new Date(date.getTime() + 30 * 60000);

    let title = text.replace(/at .*/i, "").trim();

    createEvent(title, date, endDate);
  }

  mic.onclick = () => {
    ring.classList.add("active");
    recognition.start();
  };

  recognition.onend = () => ring.classList.remove("active");

});
</script>

<script src="https://accounts.google.com/gsi/client" async defer></script>

</body>
</html>
