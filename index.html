<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VoiceCal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="color-scheme" content="light dark">

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#4285f4">
<link rel="icon" href="/icon.png">

<style>
:root {
  --bg: #f4f6f9;
  --card: #ffffff;
  --text: #111111;
  --subtle: #666666;
  --mic-bg: #ffffff;
  --shadow: rgba(0,0,0,0.15);
}

/* ðŸŒ™ Auto Dark Mode */
@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0f1115;
    --card: #1c1f26;
    --text: #f1f1f1;
    --subtle: #aaaaaa;
    --mic-bg: #1c1f26;
    --shadow: rgba(0,0,0,0.6);
  }
}

body {
  font-family: Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  text-align: center;
  padding: 30px;
  margin: 0;
  transition: background 0.25s ease, color 0.25s ease;
}

.container { max-width: 500px; margin: auto; }

.mic-button {
  width: 120px;
  height: 120px;
  margin: 30px auto;
  border-radius: 50%;
  background: var(--mic-bg);
  box-shadow: 0 6px 18px var(--shadow);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 50px;
}

.recording {
  background: #ff4d4d !important;
  box-shadow: 0 0 25px rgba(255,0,0,0.6);
}

.card {
  background: var(--card);
  padding: 15px;
  margin-top: 15px;
  border-radius: 12px;
  box-shadow: 0 4px 10px var(--shadow);
  text-align: left;
}

#status { margin-top: 20px; font-weight: bold; }
</style>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>
</head>

<body>

<div class="container">
  <h1>VoiceCal</h1>
  <p>Version 4.4</p>

  <div class="mic-button" id="micBtn" onclick="startListening()">
    ðŸŽ¤
  </div>

  <div class="card" id="transcriptCard" style="display:none;">
    <strong>You said:</strong>
    <div id="transcript"></div>
  </div>

  <div id="status">Ready.</div>
</div>

<script>
const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.comD";
const API_KEY = "AIzaSyBmvb2xvKm0zagn20ZGYTE4nwQbHob-bso";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

let tokenClient;
let pendingEvent = null;
let recognition;
let finalTranscript = "";

/* ðŸ”” Ding */
function playDing() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = "sine";
  osc.frequency.setValueAtTime(880, ctx.currentTime);
  gain.gain.setValueAtTime(0.2, ctx.currentTime);
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime + 0.15);
}

function setStatus(msg) {
  document.getElementById("status").innerText = msg;
}

function speak(text) {
  speechSynthesis.speak(new SpeechSynthesisUtterance(text));
}

/* ðŸ§¹ Clean Title */
function cleanTitle(text) {
  let cleaned = text.toLowerCase();
  cleaned = cleaned.replace(/\b(remind me to|please)\b/gi, "");
  cleaned = cleaned.replace(/\b(sunday|monday|tuesday|wednesday|thursday|friday|saturday)\b/gi, "");
  cleaned = cleaned.replace(/\btomorrow\b/gi, "");
  cleaned = cleaned.replace(/\b\d{1,2}(:\d{2})?\s?(a\.?m\.?|p\.?m\.?)\b/gi, "");
  cleaned = cleaned.replace(/\b(noon|midnight)\b/gi, "");
  cleaned = cleaned.replace(/\bat\b/gi, "");
  cleaned = cleaned.replace(/\s+/g, " ").trim();
  cleaned = cleaned.charAt(0).toUpperCase() + cleaned.slice(1);
  return cleaned || "New Event";
}

function nextWeekday(target) {
  const today = new Date();
  const day = today.getDay();
  let diff = (target + 7 - day) % 7;
  if (diff === 0) diff = 7;
  const result = new Date(today);
  result.setDate(today.getDate() + diff);
  return result;
}

/* Google Init */
function initGapi() {
  gapi.load("client", async () => {
    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
    });
  });
}

function initGIS() {
  function wait() {
    if (!window.google?.accounts?.oauth2) {
      setTimeout(wait, 100);
      return;
    }
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: handleTokenResponse,
    });
  }
  wait();
}

async function handleTokenResponse(resp) {
  if (resp.error) {
    setStatus("Authentication failed.");
    return;
  }

  gapi.client.setToken({ access_token: resp.access_token });

  try {
    await gapi.client.calendar.events.insert({
      calendarId: "primary",
      resource: pendingEvent
    });
    setStatus("âœ… Event created!");
    speak("Event created.");
  } catch {
    setStatus("Failed to create event.");
  }
}

/* ðŸŽ¤ Voice */
function startListening() {
  const mic = document.getElementById("micBtn");

  if (!('webkitSpeechRecognition' in window)) {
    alert("Speech recognition not supported.");
    return;
  }

  finalTranscript = "";
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'en-US';

  mic.classList.add("recording");
  setStatus("Listening...");
  playDing();
  if (navigator.vibrate) navigator.vibrate(80);

  recognition.start();

  recognition.onresult = e => {
    finalTranscript = e.results[0][0].transcript;
  };

  recognition.onend = () => {
    mic.classList.remove("recording");

    if (!finalTranscript) {
      setStatus("No speech detected.");
      return;
    }

    document.getElementById("transcript").innerText = finalTranscript;
    document.getElementById("transcriptCard").style.display = "block";

    if (finalTranscript.toLowerCase().includes("never mind")) {
      setStatus("Cancelled.");
      speak("Cancelled.");
      return;
    }

    parseText(finalTranscript);
  };
}

/* ðŸ§  Parser */
function parseText(text) {
  const lower = text.toLowerCase();
  let date = new Date();
  let explicitDay = false;

  const weekdays = {
    sunday:0, monday:1, tuesday:2, wednesday:3,
    thursday:4, friday:5, saturday:6
  };

  for (let day in weekdays) {
    if (lower.includes(day)) {
      date = nextWeekday(weekdays[day]);
      explicitDay = true;
    }
  }

  let hour = null;
  let minute = 0;

  if (lower.includes("noon")) hour = 12;
  else if (lower.includes("midnight")) hour = 0;
  else {
    const timeRegex = /(\d{1,2})(?::(\d{2}))?\s?(a\.?m\.?|p\.?m\.?)/i;
    const match = lower.match(timeRegex);
    if (match) {
      hour = parseInt(match[1]);
      minute = match[2] ? parseInt(match[2]) : 0;
      const period = match[3].replace(/\./g, "").toLowerCase();
      if (period === "pm" && hour < 12) hour += 12;
      if (period === "am" && hour === 12) hour = 0;
    }
  }

  if (hour !== null) {
    date.setHours(hour, minute, 0, 0);
    if (!explicitDay) {
      const now = new Date();
      if (date <= now) date.setDate(date.getDate() + 1);
    }
  }

  const end = new Date(date.getTime() + 60 * 60 * 1000);

  pendingEvent = {
    summary: cleanTitle(text),
    start: { dateTime: date.toISOString() },
    end: { dateTime: end.toISOString() },
    reminders: {
      useDefault: false,
      overrides: [{ method: "popup", minutes: 30 }]
    }
  };

  setStatus("Authenticating...");
  tokenClient.requestAccessToken({
    prompt: gapi.client.getToken() ? "" : "consent"
  });
}

initGapi();
initGIS();

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js");
}
</script>

</body>
</html>
