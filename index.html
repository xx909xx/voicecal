<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VoiceCal Clean</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
body {
  font-family: Arial;
  text-align: center;
  padding: 40px;
}

#mic {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 6px solid transparent;
  background: white;
  cursor: pointer;
}

#mic.listening {
  border: 6px solid red;
  box-shadow: 0 0 25px red;
}

#mic img {
  width: 60px;
  margin-top: 30px;
}
</style>
</head>

<body>

<h2>VoiceCal Reset</h2>

<div id="g_id_onload"
     data-client_id="YOUR_CLIENT_ID_HERE"
     data-callback="login">
</div>

<div class="g_id_signin"></div>
<br><br>

<button id="mic">
  <img src="icon.png">
</button>

<p id="log"></p>

<script>

let token = null;
let listening = false;
let timer = null;

function login() {
  const client = google.accounts.oauth2.initTokenClient({
    client_id: "YOUR_CLIENT_ID_HERE",
    scope: "https://www.googleapis.com/auth/calendar.events",
    callback: (response) => {
      token = response.access_token;
      document.getElementById("log").innerText = "Signed in.";
    }
  });
  client.requestAccessToken();
}

const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.continuous = false;
recognition.interimResults = false;
recognition.lang = "en-US";

const mic = document.getElementById("mic");

mic.onclick = () => {

  if (!token) {
    alert("Sign in first.");
    return;
  }

  recognition.start();
};

recognition.onstart = () => {
  listening = true;
  mic.classList.add("listening");

  timer = setTimeout(() => {
    recognition.stop();
  }, 20000);
};

recognition.onend = () => {
  listening = false;
  mic.classList.remove("listening");
  clearTimeout(timer);
};

recognition.onresult = (event) => {
  const text = event.results[0][0].transcript;
  document.getElementById("log").innerText = "Heard: " + text;
  schedule(text);
};

function schedule(text) {

  let now = new Date();
  let date = new Date(now);
  text = text.toLowerCase();

  const days = {
    sunday:0, monday:1, tuesday:2, wednesday:3,
    thursday:4, friday:5, saturday:6
  };

  for (let d in days) {
    if (text.includes(d)) {
      let diff = days[d] - now.getDay();
      if (diff <= 0) diff += 7;
      date.setDate(now.getDate() + diff);
      break;
    }
  }

  if (text.includes("tomorrow")) {
    date.setDate(now.getDate() + 1);
  }

  const match = text.match(/(\d{1,2})(?::(\d{2}))?\s*(a\.?m\.?|p\.?m\.?)/);

  let h = 9;
  let m = 0;

  if (match) {
    h = parseInt(match[1]);
    m = match[2] ? parseInt(match[2]) : 0;
    let mer = match[3].toLowerCase();
    if (mer.includes("p") && h !== 12) h += 12;
    if (mer.includes("a") && h === 12) h = 0;
  }

  date.setHours(h);
  date.setMinutes(m);
  date.setSeconds(0);

  if (date < now) {
    date.setDate(date.getDate() + 7);
  }

  let end = new Date(date);
  end.setMinutes(end.getMinutes() + 30);

  fetch("https://www.googleapis.com/calendar/v3/calendars/primary/events", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      summary: text,
      start: { dateTime: date.toISOString(), timeZone: "America/Chicago" },
      end: { dateTime: end.toISOString(), timeZone: "America/Chicago" },
      reminders: {
        useDefault:false,
        overrides:[{method:"popup", minutes:30}]
      }
    })
  }).then(() => {
    document.getElementById("log").innerText =
      "Created: " + date.toLocaleString();
  });
}

</script>
</body>
</html>
