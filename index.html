<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>VoiceCal</title>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<style>
body {
  margin: 0;
  background: #111;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

#micButton {
  width: 160px;
  height: 160px;
  border-radius: 50%;
  border: 6px solid transparent;
  background-color: #222;
  cursor: pointer;
  transition: 0.3s;
}

.listening {
  border: 6px solid red;
  animation: pulse 1.2s infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.7); }
  70% { box-shadow: 0 0 0 25px rgba(255,0,0,0); }
  100% { box-shadow: 0 0 0 0 rgba(255,0,0,0); }
}
</style>
</head>

<body>

<button id="micButton"></button>

<script>
const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

let accessToken = null;
let tokenClient = null;

window.onload = () => {
  if (window.google && google.accounts) {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (resp) => {
        if (resp.error) return console.error(resp);
        accessToken = resp.access_token;
        console.log("Authenticated");
      }
    });
  }
};

function authenticate() {
  return new Promise((resolve) => {
    if (accessToken) return resolve();
    tokenClient.callback = (resp) => {
      accessToken = resp.access_token;
      resolve();
    };
    tokenClient.requestAccessToken({ prompt: "consent" });
  });
}

function startListening() {
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "en-US";
  recognition.start();

  const button = document.getElementById("micButton");
  button.classList.add("listening");

  recognition.onresult = async (event) => {
    button.classList.remove("listening");
    const transcript = event.results[0][0].transcript;
    await handleCommand(transcript);
  };

  recognition.onerror = () => {
    button.classList.remove("listening");
  };
}

async function handleCommand(text) {
  text = text.toLowerCase();

  let date = new Date();
  if (text.includes("tomorrow")) {
    date.setDate(date.getDate() + 1);
  }

  const match = text.match(/(\d{1,2}):(\d{2})\s?(a\.?m\.?|p\.?m\.?)/);
  if (!match) {
    speak("I couldn't detect the time.");
    return;
  }

  let hour = parseInt(match[1]);
  let minute = parseInt(match[2]);
  const period = match[3];

  if (period.includes("p") && hour < 12) hour += 12;
  if (period.includes("a") && hour === 12) hour = 0;

  date.setHours(hour, minute, 0);

  const end = new Date(date);
  end.setMinutes(end.getMinutes() + 30);

  const title = text.replace(/\b\w/g, l => l.toUpperCase());

  await authenticate();
  await createEvent(title, date, end);
}

function createEvent(title, start, end) {
  return new Promise((resolve, reject) => {
    gapi.load("client", async () => {
      await gapi.client.init({
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"]
      });

      gapi.client.setToken({ access_token: accessToken });

      try {
        await gapi.client.calendar.events.insert({
          calendarId: "primary",
          resource: {
            summary: title,
            start: { dateTime: start.toISOString(), timeZone: "America/Chicago" },
            end: { dateTime: end.toISOString(), timeZone: "America/Chicago" },
            reminders: {
              useDefault: false,
              overrides: [{ method: "popup", minutes: 30 }]
            }
          }
        });
        speak("Event added to your calendar.");
        resolve();
      } catch (e) {
        console.error(e);
        reject(e);
      }
    });
  });
}

function speak(text) {
  const utter = new SpeechSynthesisUtterance(text);
  speechSynthesis.speak(utter);
}

document.getElementById("micButton").addEventListener("click", startListening);
</script>

</body>
</html>
