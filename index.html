<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VoiceCal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!--
VoiceCal v2.1
Build Date: 2026-02-20
Stable OAuth + Calendar Insert
-->

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 40px;
  background: #f5f7fa;
}

button {
  padding: 12px 20px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  background: #4285f4;
  color: white;
  cursor: pointer;
}

button:disabled {
  background: #aaa;
}

#status {
  margin-top: 20px;
  font-weight: bold;
}
</style>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

</head>
<body>

<h1>VoiceCal</h1>
<p>Version 2.1 (2026-02-20)</p>

<button onclick="createTestEvent()">Create Test Event</button>

<div id="status">Ready.</div>

<script>
const CLIENT_ID = "630726897821-td0lfhcmccul798ia5f0c1h5jobja2db.apps.googleusercontent.com";
const API_KEY = "AIzaSyBmvb2xvKm0zagn20ZGYTE4nwQbHob-bso";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

let tokenClient;
let gapiReady = false;
let gisReady = false;
let pendingEvent = null;

function setStatus(msg) {
  document.getElementById("status").innerText = msg;
}

function setBusy(state) {
  document.querySelector("button").disabled = state;
}

function initGapi() {
  gapi.load("client", async () => {
    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
    });
    gapiReady = true;
  });
}

function initGIS() {
  function waitForGIS() {
    if (!window.google || !google.accounts || !google.accounts.oauth2) {
      setTimeout(waitForGIS, 100);
      return;
    }

    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: handleTokenResponse,
    });

    gisReady = true;
  }
  waitForGIS();
}

async function handleTokenResponse(resp) {

  if (resp.error) {
    console.error(resp);
    setStatus("Authentication failed.");
    setBusy(false);
    return;
  }

  // Attach token to gapi
  gapi.client.setToken({
    access_token: resp.access_token
  });

  try {
    setStatus("Creating event...");

    await gapi.client.calendar.events.insert({
      calendarId: "primary",
      resource: pendingEvent
    });

    setStatus("✅ Event created successfully!");
  } catch (err) {
    console.error(err);
    setStatus("❌ Failed to create event.");
  }

  setBusy(false);
}

function createTestEvent() {

  if (!gapiReady || !gisReady) {
    setStatus("Google API not ready yet.");
    return;
  }

  setBusy(true);
  setStatus("Authenticating...");

  const now = new Date();
  const end = new Date(now.getTime() + 60 * 60 * 1000);

  pendingEvent = {
    summary: "VoiceCal Test Event",
    description: "Created by VoiceCal v2.1",
    start: {
      dateTime: now.toISOString()
    },
    end: {
      dateTime: end.toISOString()
    }
  };

  tokenClient.requestAccessToken({
    prompt: gapi.client.getToken() ? "" : "consent"
  });
}

initGapi();
initGIS();
</script>

</body>
</html>

