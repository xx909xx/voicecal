<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VoiceCal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: #111;
  color: white;
}

h1 {
  margin-bottom: 40px;
}

.mic-container {
  position: relative;
  width: 220px;
  height: 220px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.ring {
  position: absolute;
  width: 210px;
  height: 210px;
  border-radius: 50%;
  border: 8px solid red;
  opacity: 0;
}

.ring.active {
  opacity: 1;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.08); }
  100% { transform: scale(1); }
}

#micButton {
  width: 160px;
  height: 160px;
  cursor: pointer;
  z-index: 2;
}

#status {
  margin-top: 40px;
  font-size: 18px;
  opacity: 0.85;
  text-align: center;
  max-width: 85%;
}
</style>
</head>

<body>

<h1>VoiceCal</h1>

<div class="mic-container">
  <div id="ring" class="ring"></div>
  <img src="/icon.png" id="micButton">
</div>

<p id="status">Tap mic</p>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const mic = document.getElementById("micButton");
  const ring = document.getElementById("ring");
  const status = document.getElementById("status");

  let recognition;
  let listening = false;
  let silenceTimer;

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    status.innerText = "Speech recognition not supported.";
    return;
  }

  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = "en-US";

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    status.innerText = transcript;
    handleCommand(transcript);
  };

  recognition.onerror = function() {
    stopListening();
  };

  recognition.onend = function() {
    stopListening();
  };

  function startListening() {
    recognition.start();
    listening = true;
    ring.classList.add("active");
    status.innerText = "Listening...";

    if (navigator.vibrate) navigator.vibrate(100);

    silenceTimer = setTimeout(stopListening, 6000);
  }

  function stopListening() {
    recognition.stop();
    listening = false;
    ring.classList.remove("active");
    clearTimeout(silenceTimer);
  }

  mic.addEventListener("click", function () {
    if (!listening) startListening();
    else stopListening();
  });

  // -------- SMART PARSER --------

  function handleCommand(text) {

    const lower = text.toLowerCase();

    const timeMatch = lower.match(/(\d{1,2})(?::(\d{2}))?\s?(am|pm)/);

    if (!timeMatch) {
      status.innerText = "Couldn't detect time.";
      return;
    }

    let hour = parseInt(timeMatch[1]);
    const minute = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
    const ampm = timeMatch[3];

    if (ampm === "pm" && hour !== 12) hour += 12;
    if (ampm === "am" && hour === 12) hour = 0;

    let date = new Date();

    if (lower.includes("tomorrow")) {
      date.setDate(date.getDate() + 1);
    }

    // Weekday detection
    const weekdays = ["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];
    weekdays.forEach((day, index) => {
      if (lower.includes(day)) {
        const today = date.getDay();
        let diff = index - today;
        if (diff <= 0) diff += 7;
        date.setDate(date.getDate() + diff);
      }
    });

    date.setHours(hour);
    date.setMinutes(minute);
    date.setSeconds(0);

    const endDate = new Date(date.getTime() + 30 * 60000);

    let title = text.replace(timeMatch[0], "").trim();
    title = title.replace(/tomorrow/i, "").trim();

    createGoogleEvent(title, date, endDate);
  }

  function formatDate(date) {
    return date.toISOString().replace(/-|:|\.\d+/g, "");
  }

  function createGoogleEvent(title, start, end) {
    const url =
      "https://calendar.google.com/calendar/render?action=TEMPLATE" +
      "&text=" + encodeURIComponent(title) +
      "&dates=" + formatDate(start) +
      "/" + formatDate(end);

    window.open(url, "_blank");
  }

});
</script>

</body>
</html>
