<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>VoiceCal - Version 4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body>
  <h2>VoiceCal (Version 4)</h2>
  <button onclick="startListening()">ðŸŽ¤ Speak</button>
  <p id="output"></p>

<script>
const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";
const API_KEY = "AIzaSyBmvb2xvKm0zagn20ZGYTE4nwQbHob-bso";

const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

let tokenClient;
let gapiInited = false;
let gisInited = false;

function gapiLoaded() {
  gapi.load("client", initializeGapiClient);
}

async function initializeGapiClient() {
  await gapi.client.init({
    apiKey: API_KEY,
    discoveryDocs: [DISCOVERY_DOC],
  });
  gapiInited = true;
}


function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: "",
  });
  gisInited = true;
}

window.onload = () => {
  gapiLoaded();
  gisLoaded();
};

function startListening() {
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "en-US";
  recognition.start();

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    document.getElementById("output").innerText = transcript;
    parseCommand(transcript);
  };
}

function parseCommand(text) {

  let originalText = text.toLowerCase();

  // --------------------------
  // 1ï¸âƒ£ Extract reminders safely
  // --------------------------
  let remindersArray = [];

  let reminderSectionMatch = originalText.match(/(remind me|set a reminder|with a reminder)(.*)/);

  if (reminderSectionMatch) {
    let reminderText = reminderSectionMatch[2];

    // match ALL reminders in sentence
    let reminderMatches = reminderText.matchAll(/(\d+)\s?(minutes?|hours?|days?)\s?before/g);

    for (let match of reminderMatches) {
      let value = parseInt(match[1]);
      let unit = match[2];

      let minutes = 0;

      if (unit.startsWith("minute")) minutes = value;
      if (unit.startsWith("hour")) minutes = value * 60;
      if (unit.startsWith("day")) minutes = value * 1440;

      remindersArray.push({
        method: "popup",
        minutes: minutes
      });
    }
  }

  // Default reminder
  if (remindersArray.length === 0) {
    remindersArray.push({
      method: "popup",
      minutes: 10
    });
  }

  // --------------------------
  // 2ï¸âƒ£ Strip reminder phrase from title
  // --------------------------
  let cleanTitle = originalText
    .replace(/(remind me|set a reminder|with a reminder).*/g, "")
    .replace(/\s+/g, " ")
    .trim();

  // --------------------------
  // 3ï¸âƒ£ Extract date & time
  // --------------------------
  let date = new Date();
  let timeMatch = cleanTitle.match(/(\d{1,2}):(\d{2})/);

  if (timeMatch) {
    date.setHours(parseInt(timeMatch[1]));
    date.setMinutes(parseInt(timeMatch[2]));
  }

  if (cleanTitle.includes("tomorrow")) {
    date.setDate(date.getDate() + 1);
  }

  let startISO = date.toISOString();
  let endDate = new Date(date.getTime() + 30 * 60000);
  let endISO = endDate.toISOString();

  // Remove time/date words from title
  cleanTitle = cleanTitle
    .replace(/tomorrow/g, "")
    .replace(/\d{1,2}:\d{2}.*/g, "")
    .trim();

  // --------------------------
  // 4ï¸âƒ£ Create Event
  // --------------------------
  let event = {
    summary: cleanTitle,
    start: { dateTime: startISO },
    end: { dateTime: endISO },
    reminders: {
      useDefault: false,
      overrides: remindersArray
    }
  };

  createEvent(event);
}

function createEvent(event) {
  tokenClient.callback = async (resp) => {
    if (resp.error !== undefined) throw resp;

    await gapi.client.calendar.events.insert({
      calendarId: "primary",
      resource: event,
    });

    alert("Event created!");
  };

  if (gapi.client.getToken() === null) {
    tokenClient.requestAccessToken({prompt: "consent"});
  } else {
    tokenClient.requestAccessToken({prompt: ""});
  }
}
</script>

</body>
</html>



