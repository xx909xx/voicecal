<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoiceCal</title>

<script src="https://apis.google.com/js/api.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #ffffff;
  color: #111;
  text-align: center;
}

header {
  padding: 20px 10px 5px;
  font-size: 22px;
  font-weight: bold;
}

.version {
  font-size: 12px;
  opacity: 0.6;
  margin-bottom: 20px;
}

.card {
  background: #f2f2f2;
  margin: 20px;
  padding: 20px;
  border-radius: 12px;
}

#micBtn {
  border: none;
  background: none;
  cursor: pointer;
}

#micBtn img {
  width: 90px;
  transition: 0.2s ease;
}

#micBtn.recording img {
  filter: brightness(0) saturate(100%) invert(21%) sepia(99%) saturate(7494%) hue-rotate(358deg) brightness(96%) contrast(119%);
  transform: scale(1.1);
}
</style>
</head>

<body>

<header>
VoiceCal
<div class="version">Version 5.0</div>
</header>

<button id="micBtn" onclick="startListening()">
  <img src="./icon.png" alt="Speak">
</button>

<div class="card" id="transcriptCard" style="display:none;">
  <div id="transcript"></div>
</div>

<script>
/* =========================
   GOOGLE CONFIG
   ========================= */

const API_KEY = "AIzaSyBmvb2xvKm0zagn20ZGYTE4nwQbHob-bso";
const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";

gapi.load('client:auth2', () => {
  gapi.client.init({
    apiKey: API_KEY,
    clientId: CLIENT_ID,
    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
    scope: "https://www.googleapis.com/auth/calendar.events"
  });
});

/* =========================
   VOICE RECOGNITION
   ========================= */

let recognition;
let finalTranscript = "";

function startListening() {
  const mic = document.getElementById("micBtn");

  if (!('webkitSpeechRecognition' in window)) {
    alert("Speech recognition not supported.");
    return;
  }

  finalTranscript = "";
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'en-US';
  recognition.continuous = true;
  recognition.interimResults = true;

  let silenceTimer;

  mic.classList.add("recording");
  recognition.start();

  recognition.onresult = (event) => {
    clearTimeout(silenceTimer);

    let transcript = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      transcript += event.results[i][0].transcript;
    }

    finalTranscript = transcript;

    silenceTimer = setTimeout(() => {
      recognition.stop();
    }, 2000);
  };

  recognition.onend = () => {
    mic.classList.remove("recording");

    if (!finalTranscript.trim()) return;

    document.getElementById("transcript").innerText = finalTranscript;
    document.getElementById("transcriptCard").style.display = "block";

    if (finalTranscript.toLowerCase().includes("never mind")) return;

    parseText(finalTranscript.trim());
  };
}

/* =========================
   PARSE TEXT
   ========================= */

function parseText(text) {

  let eventDate = new Date();

  // Tomorrow
  if (text.toLowerCase().includes("tomorrow")) {
    eventDate.setDate(eventDate.getDate() + 1);
  }

  // Time parsing
  const timeMatch = text.match(/(\d{1,2})(?::(\d{2}))?\s*(a\.?m\.?|p\.?m\.?)/i);

  if (timeMatch) {
    let hour = parseInt(timeMatch[1]);
    let minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
    let period = timeMatch[3].toLowerCase();

    if (period.includes("p") && hour !== 12) hour += 12;
    if (period.includes("a") && hour === 12) hour = 0;

    eventDate.setHours(hour);
    eventDate.setMinutes(minutes);
    eventDate.setSeconds(0);
  } else {
    eventDate.setHours(eventDate.getHours() + 1);
  }

  let endDate = new Date(eventDate.getTime() + 60 * 60000);

  // Clean title
  let cleanTitle = text
    .replace(/tomorrow/ig, "")
    .replace(/(\d{1,2})(?::\d{2})?\s*(a\.?m\.?|p\.?m\.?)/ig, "")
    .trim();

  createGoogleEvent(cleanTitle, eventDate, endDate);
}

/* =========================
   CREATE EVENT
   ========================= */

function createGoogleEvent(title, start, end) {

  const event = {
    summary: title,
    start: {
      dateTime: start.toISOString(),
      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
    },
    end: {
      dateTime: end.toISOString(),
      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
    },
    reminders: {
      useDefault: false,
      overrides: [
        { method: 'popup', minutes: 30 }
      ]
    }
  };

  gapi.client.calendar.events.insert({
    calendarId: 'primary',
    resource: event
  }).then(() => {
    console.log("Event created successfully");
  });
}
</script>

</body>
</html>
