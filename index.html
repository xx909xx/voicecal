<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>VoiceCal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px;
      background: #f4f6f8;
    }
    h2 { margin-bottom: 20px; }
    button {
      padding: 12px 20px;
      margin: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    #loginBtn { background: #4285F4; color: white; }
    #micBtn { background: #111; color: white; }
    #status { margin-top: 20px; font-weight: bold; }
  </style>
</head>

<body>

<h2>VoiceCal</h2>

<button id="loginBtn">Sign in with Google</button>
<br>
<button id="micBtn" disabled>ðŸŽ¤ Speak Event</button>

<div id="status"></div>

<script>
  const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";

  let tokenClient;
  let accessToken = null;

  window.onload = () => {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: "https://www.googleapis.com/auth/calendar.events",
      callback: (tokenResponse) => {
        accessToken = tokenResponse.access_token;
        document.getElementById("status").innerText = "Signed in âœ…";
        document.getElementById("micBtn").disabled = false;
      },
    });

    document.getElementById("loginBtn").onclick = () => {
      tokenClient.requestAccessToken();
    };
  };

  // Speech Recognition
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "en-US";

  document.getElementById("micBtn").onclick = () => {
    recognition.start();
    document.getElementById("status").innerText = "Listening...";
  };

  recognition.onresult = (event) => {
    let text = event.results[0][0].transcript;
    document.getElementById("status").innerText = "Heard: " + text;
    createEventFromSpeech(text);
  };

  function formatLocalDate(date) {
    const pad = (n) => n.toString().padStart(2, "0");
    return (
      date.getFullYear() + "-" +
      pad(date.getMonth() + 1) + "-" +
      pad(date.getDate()) + "T" +
      pad(date.getHours()) + ":" +
      pad(date.getMinutes()) + ":00"
    );
  }

  function cleanTitle(text) {
    return text
      .replace(/\b(tomorrow|today)\b/gi, "")
      .replace(/\bat\b/gi, "")
      .replace(/\b\d{1,2}(:\d{2})?\s?(a\.?m\.?|p\.?m\.?|am|pm)?\b/gi, "")
      .replace(/\s+/g, " ")
      .trim()
      .replace(/^\w/, c => c.toUpperCase());
  }

  async function createEventFromSpeech(text) {

    // Auto-correct common recognition mistakes
    text = text
      .replace(/\bbeat\b/gi, "meet")
      .replace(/\bmeat\b/gi, "meet");

    let now = new Date();
    let eventDate = new Date(now);

    // Tomorrow support
    if (text.toLowerCase().includes("tomorrow")) {
      eventDate.setDate(eventDate.getDate() + 1);
    }

    // Time parsing
    const timeMatch = text.match(/(\d{1,2})(?::(\d{2}))?\s?(a\.?m\.?|p\.?m\.?|am|pm)?/i);

    let hours = 9;
    let minutes = 0;

    if (timeMatch) {
      hours = parseInt(timeMatch[1]);
      minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;

      let meridian = timeMatch[3];

      if (meridian) {
        meridian = meridian.toLowerCase().replace(/\./g, "");
        if (meridian === "pm" && hours !== 12) hours += 12;
        if (meridian === "am" && hours === 12) hours = 0;
      }
    }

    eventDate.setHours(hours);
    eventDate.setMinutes(minutes);
    eventDate.setSeconds(0);

    let endDate = new Date(eventDate);
    endDate.setMinutes(endDate.getMinutes() + 30);

    const event = {
      summary: cleanTitle(text),
      start: {
        dateTime: formatLocalDate(eventDate),
        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      },
      end: {
        dateTime: formatLocalDate(endDate),
        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      },
      reminders: {
        useDefault: false,
        overrides: [
          { method: "popup", minutes: 30 }
        ],
      },
    };

    await fetch("https://www.googleapis.com/calendar/v3/calendars/primary/events", {
      method: "POST",
      headers: {
        Authorization: "Bearer " + accessToken,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(event),
    });

    document.getElementById("status").innerText = "Event Created âœ…";
  }
</script>

</body>
</html>
