<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>VoiceCal</title>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #111;
  color: white;
  text-align: center;
  margin-top: 80px;
}

#micButton {
  width: 170px;
  height: 170px;
  border-radius: 50%;
  border: none;
  background: #222;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: auto;
  position: relative;
  cursor: pointer;
}

#micButton img {
  width: 85px;
}

#ring {
  position: absolute;
  width: 210px;
  height: 210px;
  border-radius: 50%;
  border: 6px solid red;
  opacity: 0;
}

.pulse {
  animation: pulse 1.2s infinite;
  opacity: 1 !important;
}

@keyframes pulse {
  0% { transform: scale(1); opacity: 0.7; }
  50% { transform: scale(1.15); opacity: 1; }
  100% { transform: scale(1); opacity: 0.7; }
}

#status {
  margin-top: 30px;
  font-size: 18px;
}
</style>
</head>
<body>

<h2>VoiceCal</h2>

<button id="micButton">
  <div id="ring"></div>
  <img src="/icon.png" />
</button>

<p id="status">Tap mic to speak</p>

<script>
const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";

let tokenClient;
let accessToken = null;
let recognition;
let silenceTimer;

window.onload = () => {

  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: "https://www.googleapis.com/auth/calendar.events",
    callback: (response) => {
      if (response.access_token) {
        accessToken = response.access_token;
        document.getElementById("status").innerText = "Signed in. Ready.";
      }
    },
  });

  tokenClient.requestAccessToken();

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = "en-US";

  recognition.onstart = () => {
    document.getElementById("ring").classList.add("pulse");
    navigator.vibrate?.(100);
    document.getElementById("status").innerText = "Listening...";
  };

  recognition.onend = () => {
    document.getElementById("ring").classList.remove("pulse");
  };

  recognition.onresult = (event) => {
    clearTimeout(silenceTimer);
    const text = event.results[0][0].transcript;
    document.getElementById("status").innerText = "Heard: " + text;
    createCalendarEvent(text);
  };

  recognition.onerror = () => {
    document.getElementById("status").innerText = "Speech error. Try again.";
  };

  document.getElementById("micButton").onclick = () => {
    if (!accessToken) {
      tokenClient.requestAccessToken();
      return;
    }
    recognition.start();
    silenceTimer = setTimeout(() => recognition.stop(), 6000);
  };
};

function parseTime(text) {
  text = text.toLowerCase();

  const wordNumbers = {
    one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,
    ten:10,eleven:11,twelve:12
  };

  for (const word in wordNumbers) {
    const regex = new RegExp("\\b" + word + "\\b", "g");
    text = text.replace(regex, wordNumbers[word]);
  }

  const match = text.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/);
  if (!match) return null;

  let hour = parseInt(match[1]);
  let minute = match[2] ? parseInt(match[2]) : 0;
  let period = match[3];

  if (!period) {
    if (text.includes("evening") || text.includes("tonight")) period = "pm";
    if (text.includes("morning")) period = "am";
  }

  if (period === "pm" && hour < 12) hour += 12;
  if (period === "am" && hour === 12) hour = 0;

  const date = new Date();

  if (text.includes("tomorrow")) {
    date.setDate(date.getDate() + 1);
  }

  date.setHours(hour);
  date.setMinutes(minute);
  date.setSeconds(0);

  return date;
}

function createCalendarEvent(text) {

  const startTime = parseTime(text);

  if (!startTime) {
    document.getElementById("status").innerText = "Couldn't detect time.";
    return;
  }

  const endTime = new Date(startTime.getTime() + 30 * 60000);

  const event = {
    summary: text,
    start: {
      dateTime: startTime.toISOString(),
      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
    },
    end: {
      dateTime: endTime.toISOString(),
      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
    },
    reminders: {
      useDefault: false,
      overrides: [
        { method: "popup", minutes: 30 }
      ]
    }
  };

  fetch("https://www.googleapis.com/calendar/v3/calendars/primary/events", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + accessToken,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(event)
  })
  .then(res => res.json())
  .then(data => {
    if (data.id) {
      document.getElementById("status").innerText = "Event added!";
      navigator.vibrate?.([100, 50, 100]);
    } else {
      document.getElementById("status").innerText = "Calendar error.";
      console.log(data);
    }
  });
}
</script>

</body>
</html>
