<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>VoiceCal</title>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<style>
body {
  margin: 0;
  font-family: sans-serif;
  background: #111;
  color: white;
  display: flex;
  height: 100vh;
  justify-content: center;
  align-items: center;
}

#micButton {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  border: 6px solid transparent;
  background: url('/icon.png') center/60% no-repeat;
  background-color: #222;
  cursor: pointer;
  transition: 0.3s;
}

.listening {
  border: 6px solid red;
  animation: pulse 1.2s infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.6); }
  70% { box-shadow: 0 0 0 25px rgba(255,0,0,0); }
  100% { box-shadow: 0 0 0 0 rgba(255,0,0,0); }
}
</style>
</head>

<body>

<button id="micButton"></button>

<script>
const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

let tokenClient;
let accessToken;

function speak(text, callback) {
  const utter = new SpeechSynthesisUtterance(text);
  utter.onend = () => {
    if (callback) callback();
  };
  speechSynthesis.speak(utter);
}

function initGoogle() {
  gapi.load('client', async () => {
    await gapi.client.init({});
  });

  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (response) => {
      accessToken = response.access_token;
    },
  });
}

function authorizeAndRun(callback) {
  if (!accessToken) {
    tokenClient.requestAccessToken({ prompt: 'consent' });
    setTimeout(callback, 1500);
  } else {
    callback();
  }
}

function createEvent(title, startISO, endISO) {
  authorizeAndRun(async () => {
    await gapi.client.calendar.events.insert({
      calendarId: 'primary',
      resource: {
        summary: title,
        start: { dateTime: startISO, timeZone: "America/Chicago" },
        end: { dateTime: endISO, timeZone: "America/Chicago" },
        reminders: {
          useDefault: false,
          overrides: [{ method: "popup", minutes: 30 }]
        }
      }
    });

    speak("Event added to your calendar.");
  });
}

function parseCommand(text) {
  text = text.toLowerCase();

  let correctedName = null;

  if (text.includes("sherry")) {
    correctedName = "Cheri";
  }

  let date = new Date();
  if (text.includes("tomorrow")) {
    date.setDate(date.getDate() + 1);
  }

  const timeMatch = text.match(/(\d{1,2}):?(\d{2})?\s?(a\.?m\.?|p\.?m\.?)/);
  if (!timeMatch) {
    speak("I couldn't detect the time.");
    return;
  }

  let hour = parseInt(timeMatch[1]);
  let minute = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
  const period = timeMatch[3];

  if (period.includes("p") && hour < 12) hour += 12;
  if (period.includes("a") && hour === 12) hour = 0;

  date.setHours(hour, minute, 0);

  const end = new Date(date);
  end.setMinutes(end.getMinutes() + 30);

  let title = text.replace(/make/i, "").trim();

  function finalizeEvent(nameFix) {
    if (nameFix) {
      title = title.replace(/sherry/i, "Cheri");
    }

    title = title.replace(/\b\w/g, l => l.toUpperCase());

    createEvent(
      title,
      date.toISOString(),
      end.toISOString()
    );
  }

  if (correctedName) {
    speak("Did you mean Cheri?", () => {
      listenForConfirmation((answer) => {
        if (answer.includes("yes")) {
          finalizeEvent(true);
        } else {
          finalizeEvent(false);
        }
      });
    });
  } else {
    finalizeEvent(false);
  }
}

function listenForConfirmation(callback) {
  const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  rec.lang = "en-US";
  rec.start();

  rec.onresult = (event) => {
    callback(event.results[0][0].transcript.toLowerCase());
  };
}

function startListening() {
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "en-US";
  recognition.start();

  document.getElementById("micButton").classList.add("listening");

  recognition.onresult = (event) => {
    document.getElementById("micButton").classList.remove("listening");
    const transcript = event.results[0][0].transcript;
    parseCommand(transcript);
  };

  recognition.onerror = () => {
    document.getElementById("micButton").classList.remove("listening");
  };
}

document.getElementById("micButton").addEventListener("click", startListening);

initGoogle();
</script>

</body>
</html>
