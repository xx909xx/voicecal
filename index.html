<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VoiceCal - Version 6</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  margin-top: 60px;
}
button {
  font-size: 40px;
  padding: 20px;
  border-radius: 50%;
  cursor: pointer;
}
</style>
</head>

<body>

<h2>VoiceCal (Version 6)</h2>
<button onclick="startListening()">ðŸŽ¤</button>
<p id="output"></p>

<script>
const CLIENT_ID = "YOUR_CLIENT_ID_HERE";
const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

let tokenClient;
let gapiInited = false;
let gisInited = false;

gapi.load("client", async () => {
  await gapi.client.init({
    discoveryDocs: [DISCOVERY_DOC],
  });
  gapiInited = true;
});

window.onload = () => {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: "", // set later
  });
  gisInited = true;
};

function startListening() {
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "en-US";
  recognition.start();

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    document.getElementById("output").innerText = transcript;
    parseCommand(transcript);
  };
}

function parseCommand(text) {

  let workingText = text.toLowerCase();
  let remindersArray = [];

  // -------- Reminder parsing --------
  let reminderMatch = workingText.match(/(remind me|set.*reminder)(.*)/);

  if (reminderMatch) {
    let reminderText = reminderMatch[2];

    let matches = reminderText.matchAll(/(\d+)\s?(minutes?|hours?|days?)/g);

    for (let m of matches) {
      let value = parseInt(m[1]);
      let unit = m[2];

      let minutes = 0;
      if (unit.startsWith("minute")) minutes = value;
      if (unit.startsWith("hour")) minutes = value * 60;
      if (unit.startsWith("day")) minutes = value * 1440;

      remindersArray.push({
        method: "popup",
        minutes: minutes
      });
    }

    workingText = workingText.replace(reminderMatch[0], "").trim();
  }

  if (remindersArray.length === 0) {
    remindersArray.push({
      method: "popup",
      minutes: 10
    });
  }

  // -------- Date & Time --------
  let date = new Date();

  if (workingText.includes("tomorrow")) {
    date.setDate(date.getDate() + 1);
  }

  let timeMatch = workingText.match(/\b(\d{1,2}):(\d{2})\s?(am|pm)\b/);

  if (timeMatch) {
    let hour = parseInt(timeMatch[1]);
    let minute = parseInt(timeMatch[2]);
    let meridian = timeMatch[3];

    if (meridian === "pm" && hour < 12) hour += 12;
    if (meridian === "am" && hour === 12) hour = 0;

    date.setHours(hour);
    date.setMinutes(minute);
    date.setSeconds(0);
  } else {
    date.setHours(date.getHours() + 1);
    date.setMinutes(0);
    date.setSeconds(0);
  }

  let startISO = date.toISOString();
  let endISO = new Date(date.getTime() + 30 * 60000).toISOString();

  // -------- Clean Title --------
  let cleanTitle = workingText
    .replace(/tomorrow/g, "")
    .replace(/\b\d{1,2}:\d{2}\s?(am|pm)\b/g, "")
    .replace(/\s+/g, " ")
    .trim();

  let event = {
    summary: cleanTitle,
    start: { dateTime: startISO },
    end: { dateTime: endISO },
    reminders: {
      useDefault: false,
      overrides: remindersArray
    }
  };

  createEvent(event);
}

function createEvent(event) {

  tokenClient.callback = async (resp) => {
    if (resp.error) {
      console.error(resp);
      return;
    }

    await gapi.client.calendar.events.insert({
      calendarId: "primary",
      resource: event,
    });

    alert("Event created!");
  };

  if (gapi.client.getToken() === null) {
    tokenClient.requestAccessToken({ prompt: "consent" });
  } else {
    tokenClient.requestAccessToken({ prompt: "" });
  }
}
</script>

</body>
</html>
