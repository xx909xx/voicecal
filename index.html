<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>VoiceCal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px;
      background: #f4f6f8;
    }
    button {
      padding: 12px 20px;
      margin: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    #loginBtn { background: #4285F4; color: white; }
    #micBtn { background: #111; color: white; }
    #status { margin-top: 20px; font-weight: bold; }
  </style>
</head>

<body>

<h2>VoiceCal</h2>

<button id="loginBtn">Sign in with Google</button>
<br>
<button id="micBtn" disabled>ðŸŽ¤ Speak Event</button>

<div id="status"></div>

<script>
const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";

let tokenClient;
let accessToken = null;

window.onload = () => {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: "https://www.googleapis.com/auth/calendar.events",
    callback: (tokenResponse) => {
      accessToken = tokenResponse.access_token;
      document.getElementById("status").innerText = "Signed in âœ…";
      document.getElementById("micBtn").disabled = false;
    },
  });

  document.getElementById("loginBtn").onclick = () => {
    tokenClient.requestAccessToken();
  };
};

const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = "en-US";

document.getElementById("micBtn").onclick = () => {
  recognition.start();
  document.getElementById("status").innerText = "Listening...";
};

recognition.onresult = async (event) => {
  let text = event.results[0][0].transcript;
  document.getElementById("status").innerText = "Heard: " + text;

  try {
    await createEventFromSpeech(text);
  } catch (err) {
    document.getElementById("status").innerText = "Error: " + err.message;
  }
};

function formatLocalDate(date) {
  const pad = (n) => n.toString().padStart(2, "0");
  return (
    date.getFullYear() + "-" +
    pad(date.getMonth() + 1) + "-" +
    pad(date.getDate()) + "T" +
    pad(date.getHours()) + ":" +
    pad(date.getMinutes()) + ":00"
  );
}

function parseTime(text) {
  const timeMatch = text.match(/(\d{1,2})(:(\d{2}))?\s*(am|pm)?/i);
  if (!timeMatch) throw new Error("Could not detect time");

  let hour = parseInt(timeMatch[1]);
  let minute = timeMatch[3] ? parseInt(timeMatch[3]) : 0;
  const ampm = timeMatch[4];

  if (ampm) {
    if (ampm.toLowerCase() === "pm" && hour !== 12) hour += 12;
    if (ampm.toLowerCase() === "am" && hour === 12) hour = 0;
  }

  return { hour, minute };
}

function parseDate(text) {
  const today = new Date();

  if (text.toLowerCase().includes("tomorrow")) {
    today.setDate(today.getDate() + 1);
    return today;
  }

  return today;
}

async function createEventFromSpeech(text) {
  const date = parseDate(text);
  const { hour, minute } = parseTime(text);

  date.setHours(hour);
  date.setMinutes(minute);
  date.setSeconds(0);

  let endDate = new Date(date);
  endDate.setMinutes(endDate.getMinutes() + 30);

  const event = {
    summary: text,
    start: {
      dateTime: formatLocalDate(date),
      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    },
    end: {
      dateTime: formatLocalDate(endDate),
      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    },
    reminders: {
      useDefault: false,
      overrides: [
        { method: "popup", minutes: 30 }
      ],
    },
  };

  const response = await fetch(
    "https://www.googleapis.com/calendar/v3/calendars/primary/events",
    {
      method: "POST",
      headers: {
        Authorization: "Bearer " + accessToken,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(event),
    }
  );

  if (!response.ok) {
    throw new Error("Calendar event creation failed");
  }

  document.getElementById("status").innerText = "Event Created âœ…";
}
</script>

</body>
</html>
