<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VoiceCal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#111111">
<link rel="manifest" href="manifest.json">
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
:root {
  --bg: #f4f6f8;
  --card: #ffffff;
  --text: #111;
  --accent: #4285F4;
}

body.dark {
  --bg: #121212;
  --card: #1e1e1e;
  --text: #ffffff;
}

body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

.card {
  background: var(--card);
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  width: 320px;
  text-align: center;
}

h2 {
  margin-top: 0;
}

button {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  border-radius: 8px;
  border: none;
  font-size: 16px;
  cursor: pointer;
}

#loginBtn {
  background: var(--accent);
  color: white;
}

#micBtn {
  background: black;
  color: white;
}

.toggle {
  background: none;
  border: 1px solid var(--text);
  margin-top: 20px;
}

#status {
  margin-top: 15px;
  font-weight: 500;
}
</style>
</head>

<body>

<div class="card">
  <h2>VoiceCal</h2>
  <button id="loginBtn">Sign in with Google</button>
  <button id="micBtn" disabled>ðŸŽ¤ Speak Event</button>
  <button class="toggle" onclick="toggleDark()">Toggle Dark Mode</button>
  <div id="status"></div>
</div>

<script>
const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";

let tokenClient;
let accessToken = null;

window.onload = () => {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: "https://www.googleapis.com/auth/calendar.events",
    callback: (tokenResponse) => {
      accessToken = tokenResponse.access_token;
      status("Signed in âœ…");
      document.getElementById("micBtn").disabled = false;
    },
  });

  document.getElementById("loginBtn").onclick = () => {
    tokenClient.requestAccessToken();
  };
};

function status(msg) {
  document.getElementById("status").innerText = msg;
}

function toggleDark() {
  document.body.classList.toggle("dark");
}

const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = "en-US";

document.getElementById("micBtn").onclick = () => {
  recognition.start();
  status("Listening...");
};

recognition.onresult = async (event) => {
  let text = event.results[0][0].transcript;
  status("Heard: " + text);

  try {
    await createEventFromSpeech(text);
  } catch (err) {
    status("Error: " + err.message);
  }
};

function parseTime(text) {
  text = text.toLowerCase();

  if (text.includes("noon")) return { hour: 12, minute: 0 };
  if (text.includes("midnight")) return { hour: 0, minute: 0 };

  const match = text.match(/(\d{1,2})(:(\d{2}))?\s*(am|pm)?/);
  if (!match) throw new Error("Time not found");

  let hour = parseInt(match[1]);
  let minute = match[3] ? parseInt(match[3]) : 0;
  const ampm = match[4];

  if (ampm) {
    if (ampm === "pm" && hour !== 12) hour += 12;
    if (ampm === "am" && hour === 12) hour = 0;
  }

  return { hour, minute };
}

function parseDate(text) {
  const today = new Date();
  text = text.toLowerCase();

  const days = ["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];

  if (text.includes("tomorrow")) {
    today.setDate(today.getDate() + 1);
    return today;
  }

  for (let i = 0; i < days.length; i++) {
    if (text.includes(days[i])) {
      let diff = i - today.getDay();
      if (diff <= 0) diff += 7;
      today.setDate(today.getDate() + diff);
      return today;
    }
  }

  return today;
}

function formatLocalDate(date) {
  return date.toISOString();
}

async function createEventFromSpeech(text) {
  const date = parseDate(text);
  const { hour, minute } = parseTime(text);

  date.setHours(hour);
  date.setMinutes(minute);
  date.setSeconds(0);

  let end = new Date(date);
  end.setMinutes(end.getMinutes() + 30);

  const event = {
    summary: text,
    start: { dateTime: formatLocalDate(date) },
    end: { dateTime: formatLocalDate(end) },
    reminders: {
      useDefault: false,
      overrides: [{ method: "popup", minutes: 30 }]
    }
  };

  const response = await fetch(
    "https://www.googleapis.com/calendar/v3/calendars/primary/events",
    {
      method: "POST",
      headers: {
        Authorization: "Bearer " + accessToken,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(event),
    }
  );

  if (!response.ok) throw new Error("Calendar creation failed");

  status("Event Created âœ…");
}
</script>

</body>
</html>
