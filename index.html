<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>VoiceCal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- VERSION 5.6 -->
  <!-- VoiceCal Version 5.6 - Meal Logging + Title Cleanup Fix -->

  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px;
      background: #f7f7f7;
    }

    button {
      padding: 12px 20px;
      font-size: 16px;
      margin: 10px;
      cursor: pointer;
    }

    #status {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>

<body>

<h1>VoiceCal</h1>
<p>Voice-powered Google Calendar event creator</p>

<button onclick="startListening()">Start Listening</button>
<div id="status">Status: Idle</div>

<script>
/* ================================
   VoiceCal Version 5.6
   ================================ */

let recognition;
let mealMode = null;

/* ================================
   Speech Setup
   ================================ */

function speak(text) {
  const speech = new SpeechSynthesisUtterance(text);
  window.speechSynthesis.speak(speech);
}

function startListening() {
  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "en-US";
  recognition.start();

  document.getElementById("status").innerText = "Listening...";

  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript.trim();
    document.getElementById("status").innerText = "Heard: " + transcript;
    handleTranscript(transcript);
  };
}

/* ================================
   Main Voice Logic
   ================================ */

function handleTranscript(transcript) {
  const text = transcript.toLowerCase();

  /* ---------- 1. MEAL ENTRY MODE ---------- */
  if (mealMode) {
    const now = new Date();
    const end = new Date(now.getTime() + 30 * 60000);

    const summary =
      mealMode + ": " +
      transcript.charAt(0).toUpperCase() +
      transcript.slice(1);

    createCalendarEvent(summary, now, end);

    speak("Meal recorded.");
    mealMode = null;
    return;
  }

  /* ---------- 2. MEAL TRIGGERS ---------- */
  if (text === "breakfast") {
    mealMode = "BREAKFAST";
    speak("Recording.");
    return;
  }

  if (text === "lunch") {
    mealMode = "LUNCH";
    speak("Recording.");
    return;
  }

  if (text === "dinner") {
    mealMode = "DINNER";
    speak("Recording.");
    return;
  }

  if (text === "snack") {
    mealMode = "SNACK";
    speak("Recording.");
    return;
  }

  /* ---------- 3. NORMAL EVENT FLOW ---------- */

  const timeMatch = text.match(/(\d{1,2})(:\d{2})?\s?(am|pm)?/);

  if (!timeMatch) {
    speak("What time?");
    return;
  }

  const now = new Date();
  let hours = parseInt(timeMatch[1]);
  const minutes = timeMatch[2] ? parseInt(timeMatch[2].replace(":", "")) : 0;
  const ampm = timeMatch[3];

  if (ampm === "pm" && hours
