<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoiceCal</title>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: #1a73e8;
  color: white;
  font-size: 22px;
  font-weight: bold;
}

#mic {
  font-size: 26px;
  cursor: pointer;
}

#main {
  text-align: center;
  margin-top: 60px;
  font-size: 18px;
}

button {
  padding: 10px 20px;
  margin-top: 20px;
  font-size: 16px;
  cursor: pointer;
}
</style>
</head>

<body>

<header>
  <div>VoiceCal</div>
  <div id="mic">ðŸŽ¤</div>
</header>

<div id="main">
  <div id="status">Please sign in</div>
  <div id="loginDiv"></div>
</div>

<script>
const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";
const SCOPES = "https://www.googleapis.com/auth/calendar";

let tokenClient;
let accessToken = null;
let recognition;
let awaitingTime = false;
let pendingTitle = "";

function initGoogle() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (tokenResponse) => {
      accessToken = tokenResponse.access_token;
      document.getElementById("status").innerText = "Signed in. Listening...";
      startListening();
    }
  });

  document.getElementById("loginDiv").innerHTML =
    `<button onclick="requestAccess()">Sign in with Google</button>`;
}

function requestAccess() {
  tokenClient.requestAccessToken();
}

function startListening() {
  if (!('webkitSpeechRecognition' in window)) {
    alert("Speech recognition not supported.");
    return;
  }

  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = false;

  recognition.onresult = function(event) {
    const text = event.results[0][0].transcript.toLowerCase();
    document.getElementById("status").innerText = "You said: " + text;
    processCommand(text);
  };

  recognition.onend = function() {
    recognition.start();
  };

  recognition.start();
}

function processCommand(text) {

  if (awaitingTime) {
    createEvent(pendingTitle, text);
    awaitingTime = false;
    return;
  }

  if (!text.includes("call") && !text.includes("meeting")) {
    return;
  }

  const timeMatch = text.match(/\d{1,2}(:\d{2})?\s?(am|pm)/);

  if (!timeMatch) {
    pendingTitle = text;
    awaitingTime = true;
    document.getElementById("status").innerText = "What time?";
    return;
  }

  createEvent(text, timeMatch[0]);
}

function createEvent(title, timeText) {

  const now = new Date();
  let eventDate = new Date(now);

  if (title.includes("tomorrow")) {
    eventDate.setDate(eventDate.getDate() + 1);
  }

  const timeParts = timeText.match(/(\d{1,2})(:(\d{2}))?\s?(am|pm)/);
  let hour = parseInt(timeParts[1]);
  const minutes = timeParts[3] ? parseInt(timeParts[3]) : 0;
  const ampm = timeParts[4];

  if (ampm === "pm" && hour !== 12) hour += 12;
  if (ampm === "am" && hour === 12) hour = 0;

  eventDate.setHours(hour);
  eventDate.setMinutes(minutes);
  eventDate.setSeconds(0);

  const endDate = new Date(eventDate);
  endDate.setHours(endDate.getHours() + 1);

  const event = {
    summary: title,
    start: {
      dateTime: eventDate.toISOString(),
      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
    },
    end: {
      dateTime: endDate.toISOString(),
      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
    },
    reminders: {
      useDefault: false,
      overrides: [
        { method: "popup", minutes: 30 }
      ]
    }
  };

  fetch("https://www.googleapis.com/calendar/v3/calendars/primary/events", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + accessToken,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(event)
  })
  .then(response => response.json())
  .then(data => {
    document.getElementById("status").innerText = "Event created!";
  })
  .catch(error => {
    document.getElementById("status").innerText = "Error creating event";
    console.error(error);
  });
}

window.onload = initGoogle;
</script>

</body>
</html>
