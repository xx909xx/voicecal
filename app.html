<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>VoiceCal v8.6.2</title>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Arial, sans-serif;
  display:flex;
  flex-direction:column;
  height:100vh;
  text-align:center;
}

header{
  padding:30px 0;
  font-size:24px;
}

main{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}

#ring{
  width:170px;
  height:170px;
  border-radius:50%;
  border:8px solid red;
  transition: transform 0.08s linear, box-shadow 0.08s linear;
  margin-bottom:40px;
}

button{
  padding:14px 22px;
  font-size:16px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
</style>
</head>

<body>

<header>VoiceCal v8.6.2</header>

<main>
  <div id="ring"></div>
  <button id="micBtn">Start Listening</button>
</main>

<script>

/* =============================
   GOOGLE CONFIG
============================= */

const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";
const API_KEY   = "AIzaSyBmvb2xvKm0zagn20ZGYTE4nwQbHob-bso";
const SCOPES    = "https://www.googleapis.com/auth/calendar.events";

let tokenClient;

function initGapi(){
  gapi.load("client", async () => {
    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs:[
        "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"
      ]
    });
  });
}

window.onload = initGapi;

function ensureAuth(callback){

  if(gapi.client.getToken()){
    callback();
    return;
  }

  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (resp)=>{
      if(resp.error){
        alert("Authorization failed");
        return;
      }
      gapi.client.setToken(resp);
      callback();
    }
  });

  tokenClient.requestAccessToken();
}


/* =============================
   SMOOTH PULSE
============================= */

let audioContext;
let analyser;
let dataArray;
let animationId;
let smoothVolume = 0;
const ring = document.getElementById("ring");

function animateRing(){
  analyser.getByteFrequencyData(dataArray);

  let sum=0;
  for(let i=0;i<dataArray.length;i++){
    sum+=dataArray[i];
  }

  let avg=sum/dataArray.length;

  smoothVolume = smoothVolume*0.9 + avg*0.1;

  let scale=1+(smoothVolume/110);
  if(scale>1.3) scale=1.3;

  let glow=smoothVolume*2;

  ring.style.transform=`scale(${scale})`;
  ring.style.boxShadow=`0 0 ${glow}px rgba(255,0,0,0.85)`;

  animationId=requestAnimationFrame(animateRing);
}

function stopRing(){
  cancelAnimationFrame(animationId);
  ring.style.transform="scale(1)";
  ring.style.boxShadow="0 0 0px red";
}


/* =============================
   SPEECH RECOGNITION
============================= */

const recognition = new SpeechRecognition();
recognition.lang="en-US";
recognition.interimResults=false;
recognition.continuous=false;

recognition.onstart = async ()=>{
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  audioContext = new AudioContext();
  analyser = audioContext.createAnalyser();
  const source = audioContext.createMediaStreamSource(stream);
  analyser.fftSize=256;
  dataArray=new Uint8Array(analyser.frequencyBinCount);
  source.connect(analyser);
  animateRing();
};

recognition.onend = ()=>{
  stopRing();
};

recognition.onerror = (e)=>{
  console.error("Speech error:", e);
  stopRing();
};

recognition.onresult = (event)=>{
  const text = event.results[0][0].transcript.toLowerCase();
  console.log("Heard:", text);
  createEventFromSpeech(text);
};


/* =============================
   TIME PARSER
============================= */

function parseTime(text){

  if(text.includes("noon")) return {hour:12,minute:0};
  if(text.includes("midnight")) return {hour:0,minute:0};

  let match=text.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)/);

  if(!match) return null;

  let hour=parseInt(match[1]);
  let minute=match[2]?parseInt(match[2]):0;
  let ampm=match[3];

  if(ampm==="pm" && hour!==12) hour+=12;
  if(ampm==="am" && hour===12) hour=0;

  return {hour,minute};
}


/* =============================
   CREATE EVENT
============================= */

function createEventFromSpeech(text){

  let time=parseTime(text);

  if(!time){
    alert("Please include a time like 6pm.");
    return;
  }

  let cleanTitle=text
    .replace(/at\s+\d.*(am|pm)/,"")
    .replace(/noon|midnight/,"")
    .trim();

  let now=new Date();

  let start=new Date(
    now.getFullYear(),
    now.getMonth(),
    now.getDate(),
    time.hour,
    time.minute
  );

  if(start<now) start.setDate(start.getDate()+1);

  let end=new Date(start.getTime()+60*60*1000);

  ensureAuth(async ()=>{

    await gapi.client.calendar.events.insert({
      calendarId:"primary",
      resource:{
        summary:cleanTitle,
        start:{dateTime:start.toISOString()},
        end:{dateTime:end.toISOString()},
        reminders:{
          useDefault:false,
          overrides:[{method:"popup",minutes:30}]
        }
      }
    });

    alert("Event created:\n"+cleanTitle+"\n"+start.toLocaleString());
  });
}


/* =============================
   BUTTON
============================= */

document.getElementById("micBtn").onclick=()=>{
  recognition.start();
};

</script>

</body>
</html>
