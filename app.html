<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>VoiceCal v8.1</title>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<style>
body {
  margin:0;
  height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  background:#000;
  color:#fff;
  font-family:Arial, sans-serif;
  text-align:center;
}

h1 {
  position:absolute;
  top:20px;
  width:100%;
  font-size:22px;
}

#micWrapper {
  width:140px;
  height:140px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  border:6px solid #333;
  transition:border 0.2s ease;
}

#micWrapper.recording {
  border:6px solid red;
}

#micBtn {
  width:90px;
  height:90px;
  border:none;
  border-radius:50%;
  background:#111;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}

#micBtn img {
  width:60px;
  height:60px;
}

#status {
  margin-top:25px;
  font-size:16px;
  opacity:0.8;
}

#card {
  margin-top:30px;
  background:#111;
  padding:20px;
  border-radius:12px;
  width:80%;
  max-width:400px;
  display:none;
}
</style>
</head>

<body>

<h1>VoiceCal v8.1</h1>

<div id="micWrapper">
  <button id="micBtn">
    <img src="icon.png">
  </button>
</div>

<div id="status">Tap mic to speak</div>
<div id="card"></div>

<script>

const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";
const API_KEY = "AIzaSyBmvb2xvKm0zagn20ZGYTE4nwQbHob-bso";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

let tokenClient;
let gapiInited = false;
let mode = "command";
let pendingEvent = null;

const micWrapper = document.getElementById("micWrapper");
const statusDiv = document.getElementById("status");
const cardDiv = document.getElementById("card");

let recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = "en-US";
recognition.interimResults = false;
recognition.continuous = false;

recognition.onstart = () => {
  micWrapper.classList.add("recording");
};

recognition.onend = () => {
  micWrapper.classList.remove("recording");
};

recognition.onresult = (event) => {
  const text = event.results[0][0].transcript.toLowerCase().trim();
  console.log("Heard:", text);

  if (mode === "command") {
    handleCommand(text);
  } else if (mode === "confirm") {
    handleConfirmation(text);
  }
};

document.getElementById("micBtn").onclick = () => {
  statusDiv.innerText = "Listening...";
  recognition.start();
};

function handleCommand(text) {

  const mealMatch = text.match(/^(breakfast|lunch|dinner|snack)\s*:\s*(.*)/i);
  if (mealMatch) {
    createMealEvent(mealMatch[1], mealMatch[2]);
    return;
  }

  if (text.includes("noon")) text = text.replace("noon", "12:00 pm");
  if (text.includes("midnight")) text = text.replace("midnight", "12:00 am");

  const timeMatch = text.match(/(\d{1,2}(:\d{2})?\s*(am|pm))/i);
  if (!timeMatch) {
    statusDiv.innerText = "Please include a time.";
    return;
  }

  const date = new Date();
  const timeStr = timeMatch[0];

  let [time, meridian] = timeStr.split(/\s+/);
  let [hour, minute] = time.split(":");
  hour = parseInt(hour);
  minute = minute ? parseInt(minute) : 0;

  if (meridian.toLowerCase() === "pm" && hour !== 12) hour += 12;
  if (meridian.toLowerCase() === "am" && hour === 12) hour = 0;

  date.setHours(hour);
  date.setMinutes(minute);
  date.setSeconds(0);

  const end = new Date(date.getTime() + 60*60*1000);

  pendingEvent = {
    summary: text,
    start: { dateTime: date.toISOString() },
    end: { dateTime: end.toISOString() }
  };

  showConfirmation();
}

function createMealEvent(type, desc) {

  const now = new Date();
  const end = new Date(now.getTime() + 30*60*1000);

  pendingEvent = {
    summary: `${type.toUpperCase()}: ${desc}`,
    start: { dateTime: now.toISOString() },
    end: { dateTime: end.toISOString() }
  };

  showConfirmation(true);
}

function showConfirmation(isMeal=false) {
  mode = "confirm";

  cardDiv.style.display = "block";
  cardDiv.innerHTML = `
    <b>Create Event?</b><br><br>
    ${pendingEvent.summary}<br><br>
    Say "yes" or "no"
  `;

  statusDiv.innerText = "Waiting for confirmation...";
  setTimeout(() => recognition.start(), 400);
}

function handleConfirmation(text) {

  if (text.includes("yes")) {
    statusDiv.innerText = "Authorizing...";
    authorizeAndCreate();
  } else {
    statusDiv.innerText = "Cancelled.";
    cardDiv.style.display = "none";
    mode = "command";
  }
}

function authorizeAndCreate() {

  if (!gapiInited) {
    gapi.load("client", async () => {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
      });
      gapiInited = true;
      requestToken();
    });
  } else {
    requestToken();
  }
}

function requestToken() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: async (tokenResponse) => {
      if (tokenResponse.error) {
        statusDiv.innerText = "Auth failed.";
        return;
      }
      gapi.client.setToken(tokenResponse);
      await createEvent();
    },
  });
  tokenClient.requestAccessToken();
}

async function createEvent() {
  await gapi.client.calendar.events.insert({
    calendarId: "primary",
    resource: pendingEvent
  });

  statusDiv.innerText = "Event created!";
  cardDiv.style.display = "none";
  mode = "command";
}

</script>
</body>
</html>
