<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>VoiceCal</title>

<!-- LINE 12: GOOGLE CLIENT ID -->
<meta name="google-signin-client_id" content="YOUR_CLIENT_ID.apps.googleusercontent.com">

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<style>
:root {
  --bg-light: #f4f4f4;
  --bg-dark: #121212;
  --text-light: #111;
  --text-dark: #fff;
  --button: #4a90e2;
}

@media (prefers-color-scheme: dark) {
  body { background: var(--bg-dark); color: var(--text-dark); }
}

@media (prefers-color-scheme: light) {
  body { background: var(--bg-light); color: var(--text-light); }
}

body {
  font-family: Arial;
  text-align: center;
  padding: 40px;
}

button {
  background: var(--button);
  color: white;
  border: none;
  padding: 14px 24px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  margin: 8px;
}

.version {
  margin-top: 25px;
  font-size: 13px;
  opacity: 0.6;
}
</style>
</head>

<body>

<h1>ðŸŽ¤ VoiceCal</h1>

<button onclick="handleAuthClick()">Sign in with Google</button>
<button onclick="startListening()">Start Listening</button>

<div id="status">Ready</div>
<div class="version">Version 6.8</div>

<script>
const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com"; // LINE 61
const API_KEY = "AIzaSyBmvb2xvKm0zagn20ZGYTE4nwQbHob-bso";
const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

let tokenClient;
let gapiInited = false;
let gisInited = false;

gapi.load("client", initializeGapiClient);

async function initializeGapiClient() {
  await gapi.client.init({
    apiKey: API_KEY,
    discoveryDocs: [DISCOVERY_DOC],
  });
  gapiInited = true;
}

function handleAuthClick() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID, // LINE 84
    scope: SCOPES,
    callback: (resp) => {
      if (resp.error !== undefined) {
        throw resp;
      }
      document.getElementById("status").innerText = "Signed in";
    },
  });
  tokenClient.requestAccessToken();
}

function startListening() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("Speech recognition not supported.");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = false;
  recognition.interimResults = false;

  document.getElementById("status").innerText = "Listening...";
  recognition.start();

  setTimeout(() => recognition.stop(), 10000);

  recognition.onresult = function(event) {
    const text = event.results[0][0].transcript.trim();
    document.getElementById("status").innerText = "Heard: " + text;
    createEvent(text);
  };

  recognition.onend = function() {
    document.getElementById("status").innerText = "Ready";
  };
}

function createEvent(text) {

  const isMeal = text.toUpperCase().startsWith("MEAL:");

  const start = new Date();
  const end = new Date(start.getTime() + 30 * 60000);

  const event = {
    summary: text,
    start: { dateTime: start.toISOString() },
    end: { dateTime: end.toISOString() }
  };

  // Only add reminder if NOT meal
  if (!isMeal) {
    event.reminders = {
      useDefault: false,
      overrides: [{ method: "popup", minutes: 10 }]
    };
  }

  gapi.client.calendar.events.insert({
    calendarId: "primary",
    resource: event,
  }).then(() => {
    document.getElementById("status").innerText = "Event Created";
  });
}
</script>

</body>
</html>
