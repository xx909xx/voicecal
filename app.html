<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VoiceCal v8.5.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<style>
body{
  font-family:Arial, sans-serif;
  text-align:center;
  background:#f4f6f9;
  margin:0;
  padding:0;
}

h1{
  margin-top:30px;
}

#micBtn{
  margin-top:40px;
  background:none;
  border:none;
  cursor:pointer;
}

#ring{
  width:160px;
  height:160px;
  border-radius:50%;
  border:8px solid transparent;
  display:flex;
  align-items:center;
  justify-content:center;
  margin:auto;
  transition:0.2s;
}

#ring.active{
  border:8px solid red;
  animation:pulse 0.8s infinite, vibrate 0.15s infinite;
}

@keyframes pulse{
  0%{ transform:scale(1); }
  50%{ transform:scale(1.08); }
  100%{ transform:scale(1); }
}

@keyframes vibrate{
  0%{ transform:translate(0px,0px); }
  25%{ transform:translate(1px,-1px); }
  50%{ transform:translate(-1px,1px); }
  75%{ transform:translate(1px,1px); }
  100%{ transform:translate(0px,0px); }
}

#micIcon{
  font-size:60px;
}

#status{
  margin-top:25px;
  font-weight:bold;
  min-height:24px;
}
</style>
</head>

<body>

<h1>VoiceCal v8.5.0</h1>

<button id="micBtn">
  <div id="ring">
    <div id="micIcon">ðŸŽ¤</div>
  </div>
</button>

<div id="status"></div>

<script>
const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";
const API_KEY = "AIzaSyBmvb2xvKm0zagn20ZGYTE4nwQbHob-bso";

const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

let tokenClient;
let gapiInited = false;
let gisInited = false;

function gapiLoaded(){
  gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient(){
  await gapi.client.init({
    apiKey: API_KEY,
    discoveryDocs: [DISCOVERY_DOC],
  });
  gapiInited = true;
}

function gisLoaded(){
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: '',
  });
  gisInited = true;
}

gapiLoaded();
gisLoaded();

function extractTime(text){

  let normalized = text
    .toLowerCase()
    .replace(/\./g,"")
    .replace(/\bp\s*m\b/g,"pm")
    .replace(/\ba\s*m\b/g,"am");

  if(normalized.includes("noon")) return {hour:12, minute:0};
  if(normalized.includes("midnight")) return {hour:0, minute:0};

  let match = normalized.match(/(\d{1,2})(:(\d{2}))?\s*(am|pm)/);

  if(!match) return null;

  let hour = parseInt(match[1]);
  let minute = match[3] ? parseInt(match[3]) : 0;
  let period = match[4];

  if(period === "pm" && hour !== 12) hour += 12;
  if(period === "am" && hour === 12) hour = 0;

  return {hour, minute};
}

function cleanTitle(text){

  let normalized = text
    .toLowerCase()
    .replace(/\./g,"")
    .replace(/\bp\s*m\b/g,"pm")
    .replace(/\ba\s*m\b/g,"am");

  normalized = normalized
    .replace(/at\s+\d{1,2}(:\d{2})?\s*(am|pm)/i,"")
    .replace(/\d{1,2}(:\d{2})?\s*(am|pm)/i,"")
    .replace(/\bnoon\b/i,"")
    .replace(/\bmidnight\b/i,"")
    .replace(/\s+/g," ")
    .trim();

  return normalized;
}

function createEvent(title, timeObj){

  if(!timeObj){
    document.getElementById("status").innerText = "Please include a time.";
    return;
  }

  let now = new Date();
  let start = new Date(
    now.getFullYear(),
    now.getMonth(),
    now.getDate(),
    timeObj.hour,
    timeObj.minute
  );

  let end = new Date(start.getTime() + 60*60*1000);

  let event = {
    summary: title,
    start: {
      dateTime: start.toISOString(),
      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
    },
    end: {
      dateTime: end.toISOString(),
      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
    },
    reminders: {
      useDefault: false,
      overrides: [
        { method: "popup", minutes: 30 }
      ]
    }
  };

  gapi.client.calendar.events.insert({
    calendarId: 'primary',
    resource: event
  }).then(() => {
    document.getElementById("status").innerText = "Event created!";
  });
}

let recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = "en-US";
recognition.interimResults = false;

document.getElementById("micBtn").onclick = () => {
  document.getElementById("status").innerText = "Listening...";
  document.getElementById("ring").classList.add("active");
  recognition.start();
};

recognition.onresult = (event) => {
  let transcript = event.results[0][0].transcript;
  console.log("Heard:", transcript);

  let timeObj = extractTime(transcript);
  let title = cleanTitle(transcript);

  createEvent(title, timeObj);
};

recognition.onend = () => {
  document.getElementById("ring").classList.remove("active");
};

recognition.onerror = () => {
  document.getElementById("ring").classList.remove("active");
  document.getElementById("status").innerText = "Error recognizing speech.";
};
</script>

</body>
</html>
