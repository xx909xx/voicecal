<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VoiceCal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<style>
body {
  font-family: Arial;
  text-align: center;
  margin-top: 80px;
}

#status {
  font-size: 20px;
  margin-top: 20px;
}

#ring {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 6px solid #ccc;
  margin: 40px auto;
  transition: 0.3s;
}

#ring.active {
  border-color: red;
  box-shadow: 0 0 25px red;
}
</style>
</head>

<body>

<h1>VoiceCal</h1>
<div id="ring"></div>
<div id="status">Listening...</div>

<script>
const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

let tokenClient;
let gapiInited = false;
let gisInited = false;

let pendingText = "";
let waitingForTime = false;
let mode = "command";

const statusDiv = document.getElementById("status");
const ring = document.getElementById("ring");

function gapiLoaded() {
  gapi.load("client", initializeGapiClient);
}

async function initializeGapiClient() {
  await gapi.client.init({});
  gapiInited = true;
}

function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: '',
  });
  gisInited = true;
}

window.onload = () => {
  gapiLoaded();
  gisLoaded();
  setTimeout(() => recognition.start(), 800);
};

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = new SpeechRecognition();
recognition.lang = "en-US";
recognition.interimResults = false;
recognition.continuous = false;

recognition.onstart = () => {
  ring.classList.add("active");
  statusDiv.innerText = "Listening...";
};

recognition.onend = () => {
  ring.classList.remove("active");
  if (mode === "command") {
    setTimeout(() => recognition.start(), 1000);
  }
};

recognition.onresult = (event) => {
  const text = event.results[0][0].transcript.toLowerCase();
  console.log("Heard:", text);

  if (waitingForTime) {
    if (!extractTime(text)) {
      statusDiv.innerText = "Please include a time like 3pm.";
      return;
    }
    pendingText += " " + text;
    waitingForTime = false;
    createCalendarEvent(pendingText);
    return;
  }

  if (!extractTime(text)) {
    pendingText = text;
    waitingForTime = true;
    statusDiv.innerText = "What time?";
    return;
  }

  createCalendarEvent(text);
};

function extractTime(text) {
  return /\b\d{1,2}(:\d{2})?\s?(am|pm)\b/.test(text);
}

function parseDateTime(text) {
  const now = new Date();
  let date = new Date();

  if (text.includes("tomorrow")) {
    date.setDate(now.getDate() + 1);
  }

  const timeMatch = text.match(/(\d{1,2})(?::(\d{2}))?\s?(am|pm)/);

  if (!timeMatch) return null;

  let hour = parseInt(timeMatch[1]);
  let minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
  const ampm = timeMatch[3];

  if (ampm === "pm" && hour !== 12) hour += 12;
  if (ampm === "am" && hour === 12) hour = 0;

  date.setHours(hour);
  date.setMinutes(minutes);
  date.setSeconds(0);

  return date;
}

function createCalendarEvent(text) {
  const start = parseDateTime(text);
  if (!start) {
    statusDiv.innerText = "Could not understand time.";
    return;
  }

  const end = new Date(start.getTime() + 30 * 60000);

  const summary =
