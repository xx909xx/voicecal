<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoiceCal</title>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<style>
:root {
  --bg-light: #f4f4f4;
  --bg-dark: #111111;
  --text-light: #111;
  --text-dark: #ffffff;
  --btn: #4a90e2;
}

@media (prefers-color-scheme: dark) {
  body { background: var(--bg-dark); color: var(--text-dark); }
}

@media (prefers-color-scheme: light) {
  body { background: var(--bg-light); color: var(--text-light); }
}

body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding-top: 80px; /* keeps it near top */
  text-align: center;
}

h1 {
  font-size: 28px;
  margin-bottom: 25px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
}

button {
  background: var(--btn);
  color: white;
  border: none;
  padding: 14px 26px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
}

button:hover { opacity: 0.9; }

#status {
  margin-top: 18px;
  font-size: 17px;
}

.version {
  margin-top: 40px;
  font-size: 13px;
  opacity: .6;
}
</style>
</head>

<body>

<h1>
  <img src="icon.png" width="28">
  <span>VoiceCal</span>
</h1>

<button id="listenBtn">Start Listening</button>

<div id="status">Ready</div>

<div class="version">Version 7.1</div>

<script>
const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";
const API_KEY = "AIzaSyBmvb2xvKm0zagn20ZGYTE4nwQbHob-bso";
const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

let tokenClient;
let gapiReady = false;

/* Load Google API */
gapi.load("client", async () => {
  await gapi.client.init({
    apiKey: API_KEY,
    discoveryDocs: [DISCOVERY_DOC],
  });
  gapiReady = true;
});

/* Setup OAuth */
window.onload = () => {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: () => {}
  });
};

document.getElementById("listenBtn").addEventListener("click", startListening);

function startListening() {

  if (!gapiReady) {
    document.getElementById("status").innerText = "Loading Google API...";
    return;
  }

  tokenClient.requestAccessToken();

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    alert("Speech recognition not supported in this browser.");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.continuous = false;

  document.getElementById("status").innerText = "Listening...";
  recognition.start();

  setTimeout(() => recognition.stop(), 10000);

  recognition.onresult = (event) => {
    const text = event.results[0][0].transcript.trim();
    document.getElementById("status").innerText = "Heard: " + text;
    createEvent(text);
  };

  recognition.onend = () => {
    document.getElementById("status").innerText = "Ready";
  };
}

function createEvent(text) {

  const isMeal = text.toUpperCase().startsWith("MEAL:");

  const start = new Date();
  const end = new Date(start.getTime() + 30 * 60000);

  const event = {
    summary: text,
    start: { dateTime: start.toISOString() },
    end: { dateTime: end.toISOString() }
  };

  if (!isMeal) {
    event.reminders = {
      useDefault: false,
      overrides: [{ method: "popup", minutes: 10 }]
    };
  }

  gapi.client.calendar.events.insert({
    calendarId: "primary",
    resource: event
  }).then(() => {
    document.getElementById("status").innerText = "Event Created";
  });
}
</script>

</body>
</html>
