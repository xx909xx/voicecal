<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VoiceCal v8.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#111;
  color:#fff;
  text-align:center;
}

h1{ margin-top:20px; }

#micBtn{
  width:120px;
  height:120px;
  border-radius:50%;
  border:8px solid #444;
  background:#222;
  cursor:pointer;
  margin-top:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:0.2s;
  padding:0;
}

#micBtn.recording{
  border:8px solid red;
}

#micIcon{
  width:60px;
  height:60px;
  pointer-events:none;
}

.card{
  background:#1e1e1e;
  padding:20px;
  margin:20px;
  border-radius:10px;
  display:none;
}

button{
  padding:10px 20px;
  margin:10px;
  font-size:16px;
}
</style>
</head>

<body>

<h1>VoiceCal v8.0</h1>

<button id="micBtn">
  <img src="icon.png" id="micIcon">
</button>

<p id="status">Tap mic to speak</p>

<div id="confirmCard" class="card">
  <h3>Confirm Event</h3>
  <p id="confirmDetails"></p>
  <button onclick="createEvent()">Yes</button>
  <button onclick="cancelEvent()">No</button>
</div>

<script>

// ====== GOOGLE CONFIG ======
const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";
const API_KEY = "AIzaSyBmvb2xvKm0zagn20ZGYTE4nwQbHob-bso";
const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

let tokenClient;
let gapiInited = false;
let gisInited = false;

function gapiLoaded(){ gapi.load('client', initializeGapiClient); }

async function initializeGapiClient(){
  await gapi.client.init({
    apiKey: API_KEY,
    discoveryDocs: [DISCOVERY_DOC],
  });
  gapiInited = true;
}

function gisLoaded(){
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: ''
  });
  gisInited = true;
}

gapiLoaded();
gisLoaded();

// ====== APP LOGIC ======

let pendingEvent=null;
const micBtn=document.getElementById("micBtn");
const statusEl=document.getElementById("status");

micBtn.onclick=startListening;

function setStatus(t){ statusEl.innerText=t; }

function startListening(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  const rec=new SR();
  rec.lang="en-US";

  micBtn.classList.add("recording");
  setStatus("Listening...");
  rec.start();

  rec.onresult=e=>{
    micBtn.classList.remove("recording");
    processCommand(e.results[0][0].transcript);
  };

  rec.onerror=()=>{
    micBtn.classList.remove("recording");
    setStatus("Error listening");
  };
}

function processCommand(text){
  const lower=text.toLowerCase().trim();
  const mealPrefixes=["breakfast:","lunch:","dinner:","snack:"];
  const isMeal=mealPrefixes.some(p=>lower.startsWith(p));

  let dateObj=extractDateTime(lower);

  if(isMeal){
    if(!dateObj) dateObj=new Date();
    const end=new Date(dateObj);
    end.setMinutes(end.getMinutes()+30);

    pendingEvent={
      summary:formatMealTitle(text),
      start:{dateTime:dateObj.toISOString()},
      end:{dateTime:end.toISOString()},
      reminders:{useDefault:false}
    };
  } else {
    if(!dateObj){ setStatus("Please include a time."); return; }
    const end=new Date(dateObj);
    end.setHours(end.getHours()+1);

    pendingEvent={
      summary:cleanSummary(text),
      start:{dateTime:dateObj.toISOString()},
      end:{dateTime:end.toISOString()},
      reminders:{useDefault:true}
    };
  }

  showConfirmation();
}

function formatMealTitle(text){
  const parts=text.split(":");
  return parts[0].toUpperCase()+": "+parts.slice(1).join(":").trim();
}

function cleanSummary(text){
  return text.replace(/tomorrow|next|this|at|in \d+ hour[s]?|morning|afternoon|evening|noon|midnight/g,"")
  .replace(/\d{1,2}(:\d{2})?\s*(am|pm)?/g,"")
  .trim();
}

function extractDateTime(text){
  const now=new Date();
  let eventDate=new Date(now);
  let hour=null,minute=0;

  const inHours=text.match(/in (\d+) hour/);
  if(inHours){ eventDate.setHours(eventDate.getHours()+parseInt(inHours[1])); return eventDate; }

  if(text.includes("tomorrow")) eventDate.setDate(eventDate.getDate()+1);

  const days=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];
  days.forEach((d,i)=>{
    if(text.includes("next "+d)){
      let diff=(7-now.getDay()+i)%7; if(diff===0) diff=7;
      eventDate.setDate(now.getDate()+diff);
    }
    if(text.includes("this "+d)){
      let diff=i-now.getDay(); if(diff<0) diff+=7;
      eventDate.setDate(now.getDate()+diff);
    }
  });

  if(text.includes("breakfast")) hour=8;
  else if(text.includes("brunch")){hour=10;minute=30;}
  else if(text.includes("lunch")) hour=12;
  else if(text.includes("dinner")) hour=18;

  if(text.includes("noon")){hour=12;minute=0;}
  else if(text.includes("midnight")){hour=0;minute=0;}
  else if(text.includes("morning")) hour=9;
  else if(text.includes("afternoon")) hour=15;
  else if(text.includes("evening")) hour=18;

  const match=text.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/);
  if(match){
    hour=parseInt(match[1]);
    minute=match[2]?parseInt(match[2]):0;
    const m=match[3];
    if(m==="pm"&&hour!==12) hour+=12;
    if(m==="am"&&hour===12) hour=0;
  }

  if(hour===null) return null;
  eventDate.setHours(hour,minute,0,0);
  return eventDate;
}

function showConfirmation(){
  const start=new Date(pendingEvent.start.dateTime);
  document.getElementById("confirmDetails").innerHTML=
    pendingEvent.summary+"<br>"+start.toLocaleString();

  document.getElementById("confirmCard").style.display="block";

  const utter=new SpeechSynthesisUtterance("Create event? Say yes or no.");
  utter.onend=listenForConfirmation;
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}

function listenForConfirmation(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  const rec=new SR();
  rec.lang="en-US";

  micBtn.classList.add("recording");
  setStatus("Say yes or no...");
  rec.start();

  rec.onresult=e=>{
    micBtn.classList.remove("recording");
    const r=e.results[0][0].transcript.toLowerCase();
    if(r.includes("yes")) createEvent();
    else cancelEvent();
  };
}

function createEvent(){
  tokenClient.callback=async resp=>{
    await gapi.client.calendar.events.insert({
      calendarId:'primary',
      resource:pendingEvent
    });
    setStatus("Event created!");
    document.getElementById("confirmCard").style.display="none";
  };

  if(gapi.client.getToken()===null){
    tokenClient.requestAccessToken({prompt:'consent'});
  } else {
    tokenClient.requestAccessToken({prompt:''});
  }
}

function cancelEvent(){
  setStatus("Cancelled");
  document.getElementById("confirmCard").style.display="none";
}

</script>
</body>
</html>
