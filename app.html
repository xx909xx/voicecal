<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VoiceCal v7 Experimental</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 30px;
  background: #f4f6f9;
}

.container {
  max-width: 500px;
  margin: auto;
}

/* Mic Button */
.mic-button {
  position: relative;
  width: 140px;
  height: 140px;
  margin: 30px auto;
  border-radius: 50%;
  background: #fff;
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 1;
}

.mic-button img {
  width: 70%;
}

/* Solid Google-style expanding ring */
.mic-button.recording::before {
  content: "";
  position: absolute;
  width: 140px;
  height: 140px;
  border-radius: 50%;
  border: 8px solid #ff0000;
  animation: solidPulse 1.5s ease-out infinite;
  z-index: -1;
}

@keyframes solidPulse {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  80% {
    transform: scale(1.6);
    opacity: 0;
  }
  100% {
    transform: scale(1.6);
    opacity: 0;
  }
}

.card {
  background: #fff;
  padding: 15px;
  margin-top: 15px;
  border-radius: 12px;
  text-align: left;
}

#status {
  margin-top: 20px;
  font-weight: bold;
}
</style>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>
</head>

<body>

<div class="container">
  <h1>VoiceCal v7</h1>

  <div class="mic-button" id="micBtn">
    <img src="icon.png" alt="Speak">
  </div>

  <div class="card" id="transcriptCard" style="display:none;">
    <strong>You said:</strong>
    <div id="transcript"></div>
  </div>

  <div class="card" id="confirmCard" style="display:none;">
    <strong>Confirm Event:</strong>
    <div id="confirmDetails"></div>
  </div>

  <div id="status">Ready.</div>
</div>

<script>
const CLIENT_ID = "YOUR_CLIENT_ID";
const API_KEY = "YOUR_API_KEY";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

let tokenClient;
let recognition;
let finalTranscript = "";
let pendingEvent = null;
let appState = "idle";

/* ---------- INIT ---------- */

function initGapi() {
  gapi.load("client", async () => {
    await gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
    });
  });
}

function initGIS() {
  function wait() {
    if (!window.google || !google.accounts || !google.accounts.oauth2) {
      setTimeout(wait, 100);
      return;
    }
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: handleTokenResponse,
    });
  }
  wait();
}

/* ---------- SPEECH ---------- */

document.getElementById("micBtn").addEventListener("click", startListening);

function startListening() {
  if (appState !== "idle") return;

  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    alert("Use Chrome.");
    return;
  }

  recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.continuous = false;

  finalTranscript = "";
  appState = "listening";
  document.getElementById("micBtn").classList.add("recording");
  setStatus("Listening...");

  recognition.start();

  recognition.onresult = (event) => {
    finalTranscript = event.results[0][0].transcript.trim();
  };

  recognition.onend = () => {
    document.getElementById("micBtn").classList.remove("recording");
    appState = "idle";

    if (!finalTranscript) {
      setStatus("No speech detected.");
      return;
    }

    showTranscript(finalTranscript);
    parseCommand(finalTranscript);
  };
}

/* ---------- PARSING ---------- */

function parseCommand(text) {
  let lower = text.toLowerCase();
  let date = new Date();

  // tomorrow support
  if (lower.includes("tomorrow")) {
    date.setDate(date.getDate() + 1);
  }

  // time detection
  const timeRegex = /(\d{1,2})(?::(\d{2}))?\s*(a\.?m\.?|p\.?m\.?)/i;
  const match = lower.match(timeRegex);

  if (!match) {
    speak("I need a time.");
    setStatus("Missing time.");
    return;
  }

  let hour = parseInt(match[1]);
  let minute = match[2] ? parseInt(match[2]) : 0;
  let period = match[3].toLowerCase();

  if (period.includes("p") && hour !== 12) hour += 12;
  if (period.includes("a") && hour === 12) hour = 0;

  date.setHours(hour, minute, 0, 0);

  const end = new Date(date.getTime() + 60 * 60 * 1000);

  let cleanTitle = text.replace(timeRegex, "").replace("tomorrow", "").trim();

  if (!cleanTitle) {
    setStatus("Missing event title.");
    return;
  }

  pendingEvent = {
    summary: cleanTitle,
    start: { dateTime: date.toISOString() },
    end: { dateTime: end.toISOString() }
  };

  showConfirmation();
}

/* ---------- CONFIRMATION ---------- */

function showConfirmation() {
  const start = new Date(pendingEvent.start.dateTime);
  const end = new Date(pendingEvent.end.dateTime);

  const dateStr = start.toLocaleDateString();
  const timeStr =
    start.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }) +
    " - " +
    end.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

  document.getElementById("confirmDetails").innerHTML =
    pendingEvent.summary + "<br>" + dateStr + "<br>" + timeStr;

  document.getElementById("confirmCard").style.display = "block";

  speak("Create event " + pendingEvent.summary + "? Say yes or no.");
  listenForConfirmation();
}

function listenForConfirmation() {
  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;

  const confirmRec = new SpeechRecognition();
  confirmRec.lang = "en-US";
  confirmRec.interimResults = false;
  confirmRec.continuous = false;

  confirmRec.start();

  confirmRec.onresult = (event) => {
    const response = event.results[0][0].transcript.toLowerCase();

    if (response.includes("yes")) {
      setStatus("Authenticating...");
      speak("Creating event.");
      tokenClient.requestAccessToken({
        prompt: gapi.client.getToken() ? "" : "consent"
      });
    } else {
      setStatus("Cancelled.");
      speak("Cancelled.");
      document.getElementById("confirmCard").style.display = "none";
    }
  };
}

/* ---------- GOOGLE INSERT ---------- */

async function handleTokenResponse(resp) {
  if (resp.error) {
    setStatus("Auth failed.");
    return;
  }

  gapi.client.setToken({ access_token: resp.access_token });

  try {
    await gapi.client.calendar.events.insert({
      calendarId: "primary",
      resource: pendingEvent
    });

    setStatus("Event created!");
    speak("Event created.");
    document.getElementById("confirmCard").style.display = "none";
  } catch (e) {
    setStatus("Calendar error.");
  }
}

/* ---------- UTIL ---------- */

function showTranscript(text) {
  document.getElementById("transcript").innerText = text;
  document.getElementById("transcriptCard").style.display = "block";
}

function speak(text) {
  speechSynthesis.speak(new SpeechSynthesisUtterance(text));
}

function setStatus(msg) {
  document.getElementById("status").innerText = msg;
}

initGapi();
initGIS();
</script>

</body>
</html>
