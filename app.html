<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VoiceCal v8.6.3</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Google Material Icons -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  text-align:center;
  background:#f5f5f5;
  padding:40px;
}

h1{
  font-size:32px;
}

button{
  padding:12px 20px;
  font-size:16px;
  margin:10px;
  cursor:pointer;
}

#micBtn{
  width:90px;
  height:90px;
  border-radius:50%;
  border:none;
  background:#4285f4;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:40px;
  transition:0.2s ease;
}

#micBtn.listening{
  background:red;
  box-shadow:0 0 20px rgba(255,0,0,0.6);
}

#status{
  margin-top:20px;
  font-weight:bold;
}
</style>
</head>
<body>

<h1>VoiceCal v8.6.3</h1>

<button id="signinBtn">Sign In</button>
<br>

<button id="micBtn">
  <span class="material-icons">mic</span>
</button>

<div id="status">Ready</div>

<script>

// (Same JS as 8.6.2 â€” unchanged)

let tokenClient;
let accessToken = null;

const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";
const API_KEY = "AIzaSyBmvb2xvKm0zagn20ZGYTE4nwQbHob-bso";

const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

gapi.load("client", async () => {
  await gapi.client.init({
    apiKey: API_KEY,
    discoveryDocs: [DISCOVERY_DOC],
  });
});

tokenClient = google.accounts.oauth2.initTokenClient({
  client_id: CLIENT_ID,
  scope: SCOPES,
  callback: (resp) => {
    accessToken = resp.access_token;
    document.getElementById("status").innerText = "Signed in";
  },
});

document.getElementById("signinBtn").onclick = () => {
  tokenClient.requestAccessToken();
};

document.getElementById("micBtn").onclick = () => startListening();

function startListening(){

  if(!('webkitSpeechRecognition' in window)){
    alert("Speech Recognition not supported in this browser.");
    return;
  }

  const recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;

  document.getElementById("micBtn").classList.add("listening");
  document.getElementById("status").innerText = "Listening...";

  recognition.start();

  recognition.onresult = (event)=>{
    const text = event.results[0][0].transcript;
    console.log("Heard:", text);
    document.getElementById("status").innerText = "Heard: " + text;
    createEventFromSpeech(text);
  };

  recognition.onerror = ()=>{
    document.getElementById("status").innerText = "Error hearing speech.";
  };

  recognition.onend = ()=>{
    document.getElementById("micBtn").classList.remove("listening");
  };
}

// Time parser same as 8.6.2
function parseTime(text){
  text = text.toLowerCase();

  const wordsToNumbers = {
    "one":1,"two":2,"three":3,"four":4,"five":5,"six":6,
    "seven":7,"eight":8,"nine":9,"ten":10,"eleven":11,"twelve":12
  };

  for (let word in wordsToNumbers){
    text = text.replace(new RegExp("\\b"+word+"\\b","g"), wordsToNumbers[word]);
  }

  text = text.replace(/p\.?\s?m\.?/g,"pm");
  text = text.replace(/a\.?\s?m\.?/g,"am");

  if(text.includes("noon")) return {hour:12,minute:0};
  if(text.includes("midnight")) return {hour:0,minute:0};

  let match = text.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)/);
  if(!match) return null;

  let hour = parseInt(match[1]);
  let minute = match[2] ? parseInt(match[2]) : 0;
  let ampm = match[3];

  if(ampm === "pm" && hour !== 12) hour += 12;
  if(ampm === "am" && hour === 12) hour = 0;

  return {hour, minute};
}

function extractTitle(text){
  return text.replace(/at\s+\d.*$/i,"").trim();
}

async function createEventFromSpeech(text){

  if(!accessToken){
    alert("Please sign in first.");
    return;
  }

  const time = parseTime(text);
  if(!time){
    alert("Please include a time like 6pm.");
    return;
  }

  const title = extractTitle(text);

  const now = new Date();
  const start = new Date();
  start.setHours(time.hour);
  start.setMinutes(time.minute);
  start.setSeconds(0);

  if(start < now){
    start.setDate(start.getDate()+1);
  }

  const end = new Date(start.getTime() + 60*60*1000);

  await gapi.client.calendar.events.insert({
    calendarId:"primary",
    resource:{
      summary:title,
      start:{dateTime:start.toISOString()},
      end:{dateTime:end.toISOString()},
      reminders:{
        useDefault:false,
        overrides:[{method:"popup",minutes:30}]
      }
    }
  });

  document.getElementById("status").innerText = "Event created: " + title;
}

</script>

</body>
</html>
