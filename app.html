<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VoiceCal v8.6.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://apis.google.com/js/api.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  text-align:center;
  background:#111;
  color:white;
  margin-top:60px;
}

#ring{
  width:150px;
  height:150px;
  border-radius:50%;
  border:8px solid red;
  margin:30px auto;
  transition: transform 0.08s linear, box-shadow 0.08s linear;
}

button{
  padding:12px 20px;
  font-size:18px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
</style>
</head>
<body>

<h1>VoiceCal v8.6.1</h1>

<div id="ring"></div>

<button onclick="handleAuth()">Sign In</button>
<button onclick="startListening()">Start Listening</button>

<script>

/* ===========================
   ðŸ” GOOGLE CONFIG
=========================== */

const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";
const API_KEY = "AIzaSyBmvb2xvKm0zagn20ZGYTE4nwQbHob-bso";

const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

function initGapi(){
  gapi.load("client:auth2", async () => {
    await gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      discoveryDocs: [DISCOVERY_DOC],
      scope: SCOPES
    });
  });
}

function handleAuth(){
  gapi.auth2.getAuthInstance().signIn();
}

window.onload = initGapi;


/* ===========================
   ðŸ”µ SMOOTH GOOGLE PULSE
=========================== */

let audioContext;
let analyser;
let microphone;
let dataArray;
let animationId;
let smoothVolume = 0;
const ring = document.getElementById("ring");

function animateRing(){
  analyser.getByteFrequencyData(dataArray);

  let sum = 0;
  for(let i=0;i<dataArray.length;i++){
    sum += dataArray[i];
  }

  let avg = sum / dataArray.length;

  smoothVolume = smoothVolume * 0.9 + avg * 0.1;

  let scale = 1 + (smoothVolume / 110);
  if(scale > 1.28) scale = 1.28;

  let glow = smoothVolume * 2;

  ring.style.transform = `scale(${scale})`;
  ring.style.boxShadow = `0 0 ${glow}px rgba(255,0,0,0.85)`;

  animationId = requestAnimationFrame(animateRing);
}

async function startListening(){

  const stream = await navigator.mediaDevices.getUserMedia({ audio:true });

  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioContext.createAnalyser();
  microphone = audioContext.createMediaStreamSource(stream);

  analyser.fftSize = 256;
  const bufferLength = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bufferLength);

  microphone.connect(analyser);

  animateRing();
}


/* ===========================
   ðŸ§  TIME PARSER
=========================== */

function parseTime(text){

  text = text.toLowerCase();

  if(text.includes("noon")){
    return { hour:12, minute:0 };
  }

  if(text.includes("midnight")){
    return { hour:0, minute:0 };
  }

  let match = text.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/);

  if(!match) return null;

  let hour = parseInt(match[1]);
  let minute = match[2] ? parseInt(match[2]) : 0;
  let ampm = match[3];

  if(ampm === "pm" && hour < 12) hour += 12;
  if(ampm === "am" && hour === 12) hour = 0;

  return { hour, minute };
}


/* ===========================
   ðŸ“… CREATE CALENDAR EVENT
=========================== */

function createEventFromSpeech(text){

  let time = parseTime(text);

  if(!time){
    alert("Please include a time.");
    return;
  }

  // Remove time words from title
  let cleanTitle = text
    .replace(/(\d{1,2})(?::\d{2})?\s*(am|pm)?/i,"")
    .replace(/noon|midnight/i,"")
    .trim();

  let now = new Date();

  let start = new Date(
    now.getFullYear(),
    now.getMonth(),
    now.getDate(),
    time.hour,
    time.minute
  );

  if(start < now){
    start.setDate(start.getDate()+1);
  }

  let end = new Date(start.getTime() + 60*60*1000);

  let event = {
    summary: cleanTitle,
    start: { dateTime: start.toISOString() },
    end: { dateTime: end.toISOString() },
    reminders: {
      useDefault:false,
      overrides:[{method:"popup", minutes:30}]
    }
  };

  gapi.client.calendar.events.insert({
    calendarId: "primary",
    resource: event
  }).then(() => {
    alert("Event Created:\n" +
      cleanTitle +
      "\n" + start.toLocaleString() +
      "\nReminder: 30 minutes before");
  });
}

</script>

</body>
</html>
