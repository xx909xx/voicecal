<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>VoiceCal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  margin-top: 80px;
  background: #f8f9fa;
}

h1 {
  font-weight: 600;
}

#status {
  font-size: 20px;
  margin-top: 20px;
}

#ring {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 6px solid #ccc;
  margin: 40px auto;
  transition: 0.3s ease;
}

#ring.active {
  border-color: red;
  box-shadow: 0 0 25px red;
}

#overlay {
  position: fixed;
  inset: 0;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  cursor: pointer;
}
</style>
</head>

<body>

<h1>VoiceCal</h1>

<div id="ring"></div>
<div id="status">Tap anywhere to start</div>

<div id="overlay">Tap Anywhere To Start</div>

<script>
const CLIENT_ID = "630726897821-4m33kk0js2fefdn102j6mumc1cooih49.apps.googleusercontent.com";
const SCOPES = "https://www.googleapis.com/auth/calendar.events";

let tokenClient;
let started = false;
let pendingText = "";
let waitingForTime = false;

const statusDiv = document.getElementById("status");
const ring = document.getElementById("ring");
const overlay = document.getElementById("overlay");


// ---------------- GOOGLE AUTH ----------------

function gapiLoaded() {
  gapi.load("client", async () => {
    await gapi.client.init({});
  });
}

function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (tokenResponse) => {
      if (tokenResponse.error) return;
    }
  });
}

gapiLoaded();
gisLoaded();


// ---------------- SPEECH SETUP ----------------

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = new SpeechRecognition();

recognition.lang = "en-US";
recognition.interimResults = false;
recognition.continuous = false;

recognition.onstart = () => {
  ring.classList.add("active");
  statusDiv.innerText = "Listening...";
};

recognition.onend = () => {
  ring.classList.remove("active");
  setTimeout(() => recognition.start(), 900);
};

recognition.onresult = (event) => {
  const text = event.results[0][0].transcript.toLowerCase();
  console.log("Heard:", text);

  if (waitingForTime) {
    if (!extractTime(text)) {
      statusDiv.innerText = "Please include a time like 3pm.";
      return;
    }
    pendingText += " " + text;
    waitingForTime = false;
    createEvent(pendingText);
    return;
  }

  if (!extractTime(text)) {
    pendingText = text;
    waitingForTime = true;
    statusDiv.innerText = "What time?";
    return;
  }

  createEvent(text);
};


// ---------------- TAP TO START ----------------

overlay.addEventListener("click", () => {
  if (!started) {
    started = true;
    overlay.style.display = "none";
    recognition.start();
  }
});


// ---------------- TIME PARSING ----------------

function extractTime(text) {
  return /\b\d{1,2}(:\d{2})?\s?(am|pm)\b/.test(text);
}

function parseDateTime(text) {
  const now = new Date();
  let date = new Date();

  if (text.includes("tomorrow")) {
    date.setDate(now.getDate() + 1);
  }

  const match = text.match(/(\d{1,2})(?::(\d{2}))?\s?(am|pm)/);
  if (!match) return null;

  let hour = parseInt(match[1]);
  let minute = match[2] ? parseInt(match[2]) : 0;
  const ampm = match[3];

  if (ampm === "pm" && hour !== 12) hour += 12;
  if (ampm === "am" && hour === 12) hour = 0;

  date.setHours(hour);
  date.setMinutes(minute);
  date.setSeconds(0);

  return date;
}


// ---------------- CREATE EVENT ----------------

function createEvent(text) {

  const start = parseDateTime(text);
  if (!start) {
    statusDiv.innerText = "Could not understand time.";
    return;
  }

  const end = new Date(start.getTime() + 30 * 60000);

  const summary = text
    .replace(/tomorrow/, "")
    .replace(/\b\d{1,2}(:\d{2})?\s?(am|pm)\b/, "")
    .trim();

  tokenClient.callback = async (resp) => {

    const event = {
      summary: summary,
      start: {
        dateTime: start.toISOString(),
        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      },
      end: {
        dateTime: end.toISOString(),
        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      },
      reminders: {
        useDefault: false,
        overrides: [
          { method: "popup", minutes: 30 }
        ]
      }
    };

    await gapi.client.calendar.events.insert({
      calendarId: "primary",
      resource: event
    });

    statusDiv.innerText = "Event Created âœ”";
  };

  tokenClient.requestAccessToken();
}

</script>

</body>
</html>
